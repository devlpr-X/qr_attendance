{% extends "base.html" %}
{% block title %}–ú–∏–Ω–∏–π —Ö–∏—á—ç—ç–ª–∏–π–Ω —Ö—É–≤–∞–∞—Ä—å{% endblock %}

{% block content %}

<style>
  .schedule-header {
    background: linear-gradient(135deg, #667eea 0%, #5977f9 100%);
    color:white; padding:1.4rem; border-radius:10px;
    margin-bottom:1.2rem;
  }
  .schedule-header h2 { margin:0 0 .3rem 0; }
  .schedule-header p { margin:.2rem 0; opacity:.95; }

  .section {
    background:white; padding:1rem; border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.06);
    margin-bottom:1.5rem;
  }
  .section h3 { margin-top:0; color:#1d5ede; margin-bottom:.7rem; }

  .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:.8rem; }
  .form-group { display:flex; flex-direction:column; }
  .form-group label { font-weight:600; margin-bottom:.25rem; }
  .form-group select, .form-group input {
    padding:.55rem; border:1px solid #ddd; border-radius:6px;
  }

  .btn { padding:.55rem .9rem; border:none; border-radius:6px;
    cursor:pointer; font-weight:600; }
  .btn-primary { background:#1d5ede; color:white; }
  .btn-danger { background:#d32f2f; color:white; }
  .btn-gray { background:#9e9e9e; color:white; }

  /* timetable */
  .table-wrapper { overflow-x:auto; margin-top:.6rem; }
  table { width:100%; border-collapse:collapse; }
  th, td { border:1px solid #eee; padding:.6rem; vertical-align:top; }
  th { background:#fafafa; text-align:center; font-weight:700; }
  .slot-box {
    background:#f0f6ff; border-left:4px solid #1d5ede;
    padding:.45rem; border-radius:6px; margin-bottom:6px; width:160px;
  }
  .slot-box strong { display:block; }
  .empty-state { text-align:center; padding:1rem; color:#777; }
/* (styles from your previous template kept) */
.table-wrapper{overflow-x:auto;margin-top:.6rem;}
.timetable th, .timetable td { border:1px solid #eee; padding:.6rem; vertical-align:top; }
.slot-box { background:#f0f6ff; border-left:4px solid #1d5ede; padding:.45rem; border-radius:6px; margin-bottom:6px; width:160px; }
.modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:9999; }
.modal { width:100%; max-width:480px; background:white; border-radius:8px; padding:1rem; }
</style>

<!-- HEADER -->
<div class="schedule-header">
  <h2>üë®‚Äçüè´ –ú–∏–Ω–∏–π —Ö—É–≤–∞–∞—Ä—å</h2>
  <p>–ë–∞–≥—à: <strong>{{ teacher_name }}</strong></p>
  <p>–û–Ω / C–µ–º–µ—Å—Ç—Ä: <strong>{{ year }} ‚Äî {{ term }}-—Ä</strong></p>
</div>

<div class="section">
  <h3>–•–∞–π–ª—Ç / –®“Ø“Ø–ª—Ç</h3>

<div class="section">
  <form method="GET">
    <div class="form-row">

      <div class="form-group">
        <label>–û–Ω</label>
        <input
          type="number"
          name="year"
          value="{{ year }}"
          min="2000"
          max="2100"
          placeholder="–û–Ω"
          style="padding:.55rem; border:1px solid #ddd; border-radius:6px;"
        >
      </div>

      <div class="form-group">
        <label>–°–µ–º–µ—Å—Ç—Ä</label>
        <select name="term">
          <option value="1" {% if term == 1 %}selected{% endif %}>1-—Ä</option>
          <option value="2" {% if term == 2 %}selected{% endif %}>2-—Ä</option>
        </select>
      </div>

    </div>

    <div style="margin-top:.8rem;">
      <button class="btn btn-primary">–®“Ø“Ø—Ö</button>
    </div>
  </form>
</div>
</div>


<!-- TIMETABLE -->
<div class="section">
  <h3>üìÖ –•—É–≤–∞–∞—Ä—å (–¶–∞–≥ √ó ”®–¥”©—Ä)</h3>

  <div class="table-wrapper">
    <table class="timetable">
      <thead>
        <tr>
          <th style="width:140px;">–¶–∞–≥</th>
          <th>–î–∞–≤–∞–∞</th>
          <th>–ú—è–≥–º–∞—Ä</th>
          <th>–õ—Ö–∞–≥–≤–∞</th>
          <th>–ü“Ø—Ä—ç–≤</th>
          <th>–ë–∞–∞—Å–∞–Ω</th>
          <th>–ë—è–º–±–∞</th>
          <th>–ù—è–º</th>
        </tr>
      </thead>
      <tbody>
        {% for slot in timeslots %}
          <tr>
            <td style="text-align:center; font-weight:700; vertical-align:middle;">
              {{ slot.name }}<br>
              <small style="color:#666;">{{ slot.slot }}</small>
            </td>

            {% for d in "0123456" %}
              <td>
                {% for p in patterns %}
                {% if p.time_setting_id == slot.id and p.day_of_week|stringformat:"s" == d %}
                    <div class="slot-box">
                      <strong>{{ p.course }}</strong>
                      <small>{{ p.lesson_type }}</small>
                      <div style="margin-top:6px; display:flex; gap:6px;">
                        <a href="{% url 'pattern_detail' p.id %}">
                          <button class="btn btn-primary" type="button">–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π</button>
                        </a>
                      </div>
                      
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- LIST VIEW -->
<div class="section">
  <h3>üìã –•–∏—á—ç—ç–ª–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç</h3>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–•–∏—á—ç—ç–ª</th>
          <th>”®–¥”©—Ä</th>
          <th>–¶–∞–≥</th>
          <th>–¢”©—Ä”©–ª</th>
          <th>–ë–∞–π—Ä—à–∏–ª</th>
        </tr>
      </thead>

      <tbody>
        {% if patterns %}
          {% for p in patterns %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>
                <strong>{{ p.course }}</strong>
                <br><small style="color:#777;">{{ p.course_code }}</small>
              </td>
              <td>{{ p.day }}</td>
              <td>{{ p.timeslot }}</td>
              <td>{{ p.lesson_type }}</td>
              <td>{{ p.location }}</td>
              
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="7" class="empty-state">–•–∏—á—ç—ç–ª –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: create session -->
<div id="modalBg" class="modal-bg">
  <div class="modal">
    <h3>–°–µ—Å—Å “Ø“Ø—Å–≥—ç—Ö</h3>
    <form id="createSessionForm">
      {% csrf_token %}
      <input type="hidden" name="pattern_id" id="modal_pattern_id" value="">
      <div style="margin:.5rem 0;">
        <label>–ù—ç—Ä (–∂–∏—à—ç—ç: 1-—Ä –¥–æ–ª–æ–æ —Ö–æ–Ω–æ–≥)</label>
        <input name="name" id="modal_name" style="width:100%; padding:.5rem;">
      </div>
      <div style="margin:.5rem 0; display:flex; gap:.6rem;">
        <div style="flex:1;">
          <label>–û–≥–Ω–æ–æ</label>
          <input type="date" name="session_date" id="modal_date" style="width:100%; padding:.5rem;" value="{{ timezone.now|date:'Y-m-d' }}">
        </div>
        <div style="width:160px;">
          <label>–•—É–≥–∞—Ü–∞–∞ (–º–∏–Ω—É—Ç)</label>
          <input type="number" name="duration_minutes" id="modal_duration" value="10" style="width:100%; padding:.5rem;">
        </div>
      </div>
      <div style="margin-top:.6rem; display:flex; justify-content:flex-end; gap:.5rem;">
        <button type="button" id="modalCancel" class="btn btn-gray">–ë–æ–ª–∏—Ö</button>
        <button type="submit" class="btn btn-primary">“Æ“Ø—Å–≥—ç—Ö</button>
      </div>
    </form>
  </div>
</div>

<script>
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
document.querySelectorAll('.create-session-btn').forEach(btn=>{
  btn.addEventListener('click', e=>{
    const pid = btn.dataset.patternId;
    document.getElementById('modal_pattern_id').value = pid;
    document.getElementById('modalBg').style.display = 'flex';
  });
});
document.getElementById('modalCancel').addEventListener('click', ()=> document.getElementById('modalBg').style.display='none');

document.getElementById('createSessionForm').addEventListener('submit', async function(ev){
  ev.preventDefault();
  const form = ev.target;
  const data = new FormData(form);
  // append CSRF from cookie if available (Django default)
  const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
  try {
    const res = await fetch("{% url 'create_session' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: data
    });
    const j = await res.json();
    if (j.ok) {
      // redirect to session detail (QR) page
      window.location.href = j.url;
    } else {
      alert('–ê–ª–¥–∞–∞: ' + (j.error || 'unknown'));
    }
  } catch(err) {
    alert('Network –∞–ª–¥–∞–∞: ' + err);
  }
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}–°—É—Ä–≥—É—É–ª—å –∑–∞—Å–∞—Ö{% endblock %}
{% block content %}

<link rel="stylesheet" href="/static/css/table_data.css">

<div style="max-width:1200px; margin:1.5rem auto;">

  <!-- –¢–æ–ª–≥–æ–π —Ö—ç—Å—ç–≥ -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
    <h2 style="margin:0; color:#0b2e78;">–°—É—Ä–≥—É—É–ª—å –∑–∞—Å–∞—Ö</h2>
    <button id="btnAddTimeslot" class="btn-primary">+ –¶–∞–≥ –Ω—ç–º—ç—Ö</button>
  </div>

  <!-- –¶–∞–≥–∏–π–Ω —Ö—É–≤–∞–∞—Ä—å -->
  <div style="background:white; padding:1.5rem; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom: 1.5rem;">
    <h3 style="margin:0 0 1rem 0; color:#0b2e78;">–¶–∞–≥–∏–π–Ω —Ö—É–≤–∞–∞—Ä—å</h3>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th style="width:80px;">‚Ññ</th>
            <th>–ù—ç—Ä</th>
            <th>–¶–∞–≥</th>
            <th style="width:100px; text-align:center;">“Æ–π–ª–¥—ç–ª</th>
          </tr>
        </thead>
        <tbody>
          {% for slot in timeslots %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ slot.name }}</td>
            <td><span class="badge">{{ slot.slot }}</span></td>
            <td style="text-align:center;">
              <button class="action-dots" onclick="openSlotMenu(event, '{{ slot.slot }}', '{{ slot.name }}')">‚ãÆ</button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" style="text-align:center; padding:2rem; color:#9ca3af;">
              –¶–∞–≥ –±“Ø—Ä—Ç–≥—ç–≥–¥—ç—ç–≥“Ø–π –±–∞–π–Ω–∞
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <!-- –°—É—Ä–≥—É—É–ª–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª -->
  <div style="background:white; padding:1.5rem; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:1.5rem;">
    <h3 style="margin:0 0 1rem 0; color:#0b2e78;">–°—É—Ä–≥—É—É–ª–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª</h3>
    
    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" value="edit_location">

      <div class="form-group">
        <label>–ù—ç—Ä</label>
        <input name="name" required value="{{ loc.name }}" />
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr 150px; gap:1rem;">
        <div class="form-group" >
          <label>”®—Ä–≥”©—Ä”©–≥</label>
          <input id="latitude" name="latitude" required value="{{ loc.lat }}" readonly  />
        </div>

        <div class="form-group" >
          <label>–£—Ä—Ç—Ä–∞–≥</label>
          <input id="longitude" name="longitude" required value="{{ loc.lon }}" readonly />
        </div>
        <div class="form-group" >
          <label>–ó–∞–π (–º)</label>
          <input id="radius_m" name="radius_m" type="number" value="{{ loc.radius_m }}" />
        </div>
      </div>

      <div style="margin-bottom:1rem;">
        <small style="color:#6b7280; margin-left:0.5rem;">–ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ –¥—ç—ç—Ä —Å–æ–Ω–≥–æ–æ—Ä–æ–π</small>
      </div>

      <div id="map" style="height:420px; border-radius:8px; border:1px solid #e5e7eb; margin-bottom:1rem;"></div>

      <div style="display:flex; gap:0.7rem;">
        <button type="submit" class="btn-primary">–•–∞–¥–≥–∞–ª–∞—Ö</button>
        <a href="{% url 'locations_list' %}"><button type="button" class="btn-secondary">–ë—É—Ü–∞—Ö</button></a>
      </div>
    </form>
  </div>


</div>


<!-- ADD TIMESLOT MODAL -->
<div id="addModal" class="modal">
  <div class="modal-content" style="max-width:480px;">
    <div class="modal-header">
      <h3 style="margin:0;">–®–∏–Ω—ç —Ü–∞–≥ –Ω—ç–º—ç—Ö</h3>
      <button class="modal-close" onclick="closeAddModal()">‚úï</button>
    </div>
    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_timeslot">
      
      <div class="form-group">
        <label>–≠—Ö–ª—ç—Ö —Ü–∞–≥</label>
        <input type="time" name="slot_start" required />
      </div>
      
      <div class="form-group">
        <label>–¢”©–≥—Å”©—Ö —Ü–∞–≥</label>
        <input type="time" name="slot_end" required />
      </div>
      
      <div class="form-group">
        <label>–ù—ç—Ä</label>
        <input type="text" name="slot_name" placeholder="–ñ–∏—à—ç—ç: I" required />
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeAddModal()">–ë–æ–ª–∏—Ö</button>
        <button type="submit" class="btn-primary">–ù—ç–º—ç—Ö</button>
      </div>
    </form>
  </div>
</div>


<!-- EDIT TIMESLOT MODAL -->
<div id="editModal" class="modal">
  <div class="modal-content" style="max-width:480px;">
    <div class="modal-header">
      <h3 style="margin:0;">–¶–∞–≥ –∑–∞—Å–∞—Ö</h3>
      <button class="modal-close" onclick="closeEditModal()">‚úï</button>
    </div>
    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" value="update_timeslot">
      <input type="hidden" id="edit_old_value" name="old_value">
      
      <div class="form-group">
        <label>–≠—Ö–ª—ç—Ö —Ü–∞–≥</label>
        <input type="time" id="edit_start" name="slot_start" required />
      </div>
      
      <div class="form-group">
        <label>–¢”©–≥—Å”©—Ö —Ü–∞–≥</label>
        <input type="time" id="edit_end" name="slot_end" required />
      </div>
      
      <div class="form-group">
        <label>–ù—ç—Ä</label>
        <input type="text" id="edit_name" name="slot_name" required />
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeEditModal()">–ë–æ–ª–∏—Ö</button>
        <button type="submit" class="btn-primary">–•–∞–¥–≥–∞–ª–∞—Ö</button>
      </div>
    </form>
  </div>
</div>


<!-- ACTION MENU (3 dots) -->
<div id="slotMenu" class="action-menu">
  <button class="action-item" onclick="editSelectedSlot()">
    <span>‚úèÔ∏è</span> –ó–∞—Å–∞—Ö
  </button>
  <button class="action-item action-delete" onclick="deleteSelectedSlot()">
    <span>üóëÔ∏è</span> –£—Å—Ç–≥–∞—Ö
  </button>
</div>

<!-- Hidden delete form -->
<form id="deleteSlotForm" method="POST" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="action" value="delete_timeslot">
  <input type="hidden" id="deleteSlotValue" name="slot_value">
</form>


<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ======================
   TIMESLOT FUNCTIONS
======================= */

let selectedSlotValue = null;
let selectedSlotName = null;

// Modal –Ω—ç—ç—Ö/—Ö–∞–∞—Ö
function openAddModal() {
  document.getElementById('addModal').style.display = 'flex';
}

function closeAddModal() {
  document.getElementById('addModal').style.display = 'none';
}

function openEditModal() {
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

document.getElementById('btnAddTimeslot').addEventListener('click', openAddModal);

// 3 —Ü—ç–≥–∏–π–Ω —Ü—ç—Å
function openSlotMenu(event, slotValue, slotName) {
  event.stopPropagation();
  selectedSlotValue = slotValue;
  selectedSlotName = slotName;

  const menu = document.getElementById('slotMenu');
  const button = event.target;
  const rect = button.getBoundingClientRect();

  menu.style.display = 'block';
  menu.style.position = 'fixed';
  menu.style.top = (rect.bottom + 5) + 'px';
  menu.style.left = (rect.left - 120) + 'px';
}

function editSelectedSlot() {
  const parts = selectedSlotValue.split('-');
  document.getElementById('edit_start').value = parts[0];
  document.getElementById('edit_end').value = parts[1];
  document.getElementById('edit_name').value = selectedSlotName;
  document.getElementById('edit_old_value').value = selectedSlotValue;

  document.getElementById('slotMenu').style.display = 'none';
  openEditModal();
}

function deleteSelectedSlot() {
  if (!confirm('–¶–∞–≥–∏–π–≥ —É—Å—Ç–≥–∞—Ö–¥–∞–∞ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?')) return;
  
  document.getElementById('deleteSlotValue').value = selectedSlotValue;
  document.getElementById('slotMenu').style.display = 'none';
  document.getElementById('deleteSlotForm').submit();
}

// Modal-—É—É–¥—ã–≥ –≥–∞–¥–Ω–∞ –¥–∞—Ä–∂ —Ö–∞–∞—Ö
window.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    e.target.style.display = 'none';
  }
  
  // Action menu –Ω—É—É—Ö
  if (!e.target.closest('.action-dots') && !e.target.closest('.action-menu')) {
    document.getElementById('slotMenu').style.display = 'none';
  }
});


/* ======================
   MAP LOGIC
======================= */

const initialLat = parseFloat('{{ loc.lat }}');
const initialLon = parseFloat('{{ loc.lon }}');
const initialRadius = parseInt('{{ loc.radius_m }}') || 100;

const map = L.map('map').setView([initialLat, initialLon], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
  maxZoom: 19,
  attribution: '¬© OpenStreetMap'
}).addTo(map);

let marker = L.marker([initialLat, initialLon]).addTo(map);
let circle = L.circle([initialLat, initialLon], {
  radius: initialRadius, 
  color: '#1d5ede', 
  fillOpacity: 0.15
}).addTo(map);

// –ì–∞–∑—Ä—ã–Ω –∑—É—Ä–∞–≥ –¥—ç—ç—Ä –¥–∞—Ä–∞—Ö
map.on('click', function(e) {
  const lat = e.latlng.lat.toFixed(6);
  const lon = e.latlng.lng.toFixed(6);

  if (marker) map.removeLayer(marker);
  if (circle) map.removeLayer(circle);

  marker = L.marker([lat, lon]).addTo(map);
  const r = parseInt(document.getElementById('radius_m').value || 100);

  circle = L.circle([lat, lon], {
    radius: r, 
    color: '#1d5ede', 
    fillOpacity: 0.15
  }).addTo(map);

  document.getElementById('latitude').value = lat;
  document.getElementById('longitude').value = lon;
});

// –ó–∞–π–Ω —Ä–∞–¥–∏—É—Å ”©”©—Ä—á–ª”©—Ö
document.getElementById('radius_m').addEventListener('input', function() {
  if (!marker) return;
  const r = parseInt(this.value || 100);

  if (circle) map.removeLayer(circle);
  circle = L.circle(marker.getLatLng(), {
    radius: r, 
    color: '#1d5ede', 
    fillOpacity: 0.15
  }).addTo(map);
});

// –ú–∏–Ω–∏–π –±–∞–π—Ä—à–∏–ª –∞–≤–∞—Ö
document.getElementById('btnLocate').addEventListener('click', function() {
  const btn = this;
  btn.disabled = true;
  btn.innerHTML = 'üîÑ –û–ª–∂ –±–∞–π–Ω–∞...';

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);

      if (marker) map.removeLayer(marker);
      if (circle) map.removeLayer(circle);

      marker = L.marker([lat, lon]).addTo(map);
      const r = parseInt(document.getElementById('radius_m').value || 100);

      circle = L.circle([lat, lon], {
        radius: r, 
        color: '#1d5ede', 
        fillOpacity: 0.15
      }).addTo(map);

      map.setView([lat, lon], 16);

      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lon;

      btn.disabled = false;
      btn.innerHTML = 'üìç –ú–∏–Ω–∏–π –±–∞–π—Ä—à–∏–ª';
    },
    err => {
      alert('–ë–∞–π—Ä—à–∏–ª –æ–ª–¥–æ—Ö–≥“Ø–π –±–∞–π–Ω–∞: ' + err.message);
      btn.disabled = false;
      btn.innerHTML = 'üìç –ú–∏–Ω–∏–π –±–∞–π—Ä—à–∏–ª';
    },
    { enableHighAccuracy: true, timeout: 8000 }
  );
});
</script>

{% endblock %}
{% extends "base.html" %}
{% block title %}Байршил засах{% endblock %}
{% block content %}

{% if error %}
  <div style="color:red; margin-bottom:0.6rem;">{{ error }}</div>
{% endif %}

<!-- Separate Timeslot Add Form (same page) -->
<h3>Шинэ цаг нэмэх</h3>
<form method="POST">
  {% csrf_token %}
  <input type="hidden" name="action" value="add_timeslot">
  <div style="max-width:700px; border-top: 1px solid #ddd; padding-top:1rem;">
    <table style="width:100%; max-width:400px; border-collapse:collapse;">
      <colgroup>
        <col style="min-width:80px; white-space:normal;">
        <col style="width:220px;">
      </colgroup>
      <tr>
        <td><label>Эхлэх цаг:</label></td>
        <td><input type="time" name="slot_start" required style="width:200px; padding:0.5rem;" /></td>
      </tr>
      <tr>
        <td><label>Төгсөх цаг:</label></td>
        <td><input type="time" name="slot_end" required style="width:200px; padding:0.5rem;" /></td>
      </tr>
      <tr>
        <td><label>Нэр:</label></td>
        <td><input type="text" name="slot_name" placeholder="I" required style="width:200px; padding:0.5rem;" /></td>
      </tr>
    </table> <br>
    <button type="submit">Цаг нэмэх</button>
  </div>
</form>


<!-- Existing Timeslots with Delete -->
<h3>Одоогийн цагууд</h3>
<table style="width:100%; border-collapse:collapse;">
  <thead>
    <tr>
      <th>Нэр</th>
      <th>Цаг</th>
      <th>Үйлдэл</th>
    </tr>
  </thead>
  <tbody>
    <!-- EDIT Timeslot Form (hidden by default) -->
    <div id="editBox" style="display:none; padding:1rem; border:1px solid #ddd; margin-top:1rem; background:#fafafa; max-width:700px;">
      <h3>Цаг засах</h3>
      
      <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_timeslot">
        <input type="hidden" id="edit_old_value" name="old_value">

        <label>Эхлэх цаг:</label><br>
        <input type="time" id="edit_start" name="slot_start" required style="width:200px; padding:0.5rem; margin-bottom:0.6rem;" />

        <label>Төгсөх цаг:</label><br>
        <input type="time" id="edit_end" name="slot_end" required style="width:200px; padding:0.5rem; margin-bottom:0.6rem;" />

        <label>Нэр:</label><br>
        <input type="text" id="edit_name" name="slot_name" required style="width:100%; padding:0.5rem; margin-bottom:0.6rem;" />

        <button type="submit">Хадгалах</button>
        <button type="button" onclick="cancelEdit()">Болих</button>
      </form>
    </div>


    {% for slot in timeslots %}
      <tr>
        <td>{{ slot.name }}</td>
        <td>{{ slot.slot }}</td>
        <td>
          <button type="button" onclick="editSlot('{{ slot.slot }}', '{{ slot.name }}')">Засах</button>
          <form method="POST" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_timeslot">
            <input type="hidden" name="slot_value" value="{{ slot.slot }}">
            <button type="submit" onclick="return confirm('Устгах уу?')">Устгах</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<hr>

<h2>Байршил засах</h2>
<hr>
<!-- Location Edit Form -->
<form method="POST">
  {% csrf_token %}
  <input type="hidden" name="action" value="edit_location">
  <div style="max-width:700px;">
    <label>Нэр:</label><br>
    <input name="name" required value="{{ loc.name }}" style="width:100%; padding:0.5rem; margin-bottom:0.6rem;" />

    <label>Өргөрөг (latitude):</label><br>
    <input id="latitude" name="latitude" required value="{{ loc.lat }}" style="width:100%; padding:0.5rem; margin-bottom:0.6rem;" readonly />

    <label>Уртраг (longitude):</label><br>
    <input id="longitude" name="longitude" required value="{{ loc.lon }}" style="width:100%; padding:0.5rem; margin-bottom:0.6rem;" readonly />

    <label>Зай (метр):</label><br>
    <input id="radius_m" name="radius_m" value="{{ loc.radius_m }}" style="width:150px; padding:0.4rem; margin-bottom:0.6rem;" />

    <div style="margin:0.6rem 0;">
      <button type="button" id="btnLocate">Авто байршил (төх)</button>
      <small style="color:#666; margin-left:0.6rem;">Газрын зураг дээр товшоод байрлалыг сонгоно</small>
    </div>

    <div id="map" style="height:420px; border:1px solid #ddd;"></div>

    <div style="margin-top:0.8rem;">
      <button type="submit">Хадгалах</button>
      <a href="{% url 'locations_list' %}"><button type="button">Буцах</button></a>
    </div>
  </div>
</form>


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
  const initialLat = parseFloat('{{ loc.lat }}');
  const initialLon = parseFloat('{{ loc.lon }}');
  const initialRadius = parseInt('{{ loc.radius_m }}') || 100;

  const map = L.map('map').setView([initialLat, initialLon], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

  let marker = L.marker([initialLat, initialLon]).addTo(map);
  let circle = L.circle([initialLat, initialLon], {radius: initialRadius, color:'#1e5edf', fillColor:'#1e5edf', fillOpacity:0.15}).addTo(map);

  document.getElementById('latitude').value = initialLat.toFixed(6);
  document.getElementById('longitude').value = initialLon.toFixed(6);

  map.on('click', function(e){
      const lat = e.latlng.lat.toFixed(6);
      const lon = e.latlng.lng.toFixed(6);
      if (marker) map.removeLayer(marker);
      if (circle) map.removeLayer(circle);
      marker = L.marker([lat, lon]).addTo(map);
      const r = parseInt(document.getElementById('radius_m').value || 100);
      circle = L.circle([lat, lon], {radius: r, color:'#1e5edf', fillColor:'#1e5edf', fillOpacity:0.15}).addTo(map);
      document.getElementById('latitude').value = lat;
      document.getElementById('longitude').value = lon;
  });

  document.getElementById('radius_m').addEventListener('input', function(){
      const r = parseInt(this.value || 0);
      if (!marker) return;
      const latlng = marker.getLatLng();
      if (circle) map.removeLayer(circle);
      circle = L.circle(latlng, {radius: r, color:'#1e5edf', fillColor:'#1e5edf', fillOpacity:0.15}).addTo(map);
  });

  document.getElementById('btnLocate').addEventListener('click', function(){
      if (!navigator.geolocation) { alert('Таны браузер геолокаций дэмжихгүй байна.'); return; }
      this.disabled = true; this.innerText = 'Олж байна...';
      navigator.geolocation.getCurrentPosition(function(pos){
          const lat = pos.coords.latitude.toFixed(6);
          const lon = pos.coords.longitude.toFixed(6);
          if (marker) map.removeLayer(marker);
          if (circle) map.removeLayer(circle);
          marker = L.marker([lat, lon]).addTo(map);
          const r = parseInt(document.getElementById('radius_m').value || 100);
          circle = L.circle([lat, lon], {radius: r, color:'#1e5edf', fillColor:'#1e5edf', fillOpacity:0.15}).addTo(map);
          map.setView([lat, lon], 16);
          document.getElementById('latitude').value = lat;
          document.getElementById('longitude').value = lon;
          document.getElementById('btnLocate').disabled = false;
          document.getElementById('btnLocate').innerText = 'Авто байршил (төх)';
      }, function(err){
          alert('Геолокац олдохгүй: ' + err.message);
          document.getElementById('btnLocate').disabled = false;
          document.getElementById('btnLocate').innerText = 'Авто байршил (төх)';
      }, {enableHighAccuracy:true, timeout:10000});
  });
</script>
<script>
  function editSlot(slotValue, slotName) {
      const editBox = document.getElementById('editBox');
  
      // slotValue = "08:00-09:30" → split
      const parts = slotValue.split('-');
      const start = parts[0];
      const end = parts[1];
  
      // Prefill
      document.getElementById('edit_start').value = start;
      document.getElementById('edit_end').value = end;
      document.getElementById('edit_name').value = slotName;
  
      // old value for backend UPDATE
      document.getElementById('edit_old_value').value = slotValue;
  
      // Show
      editBox.style.display = 'block';
  
      // Scroll to edit box (optional UX boost)
      editBox.scrollIntoView({ behavior: 'smooth' });
  }
  
  function cancelEdit() {
      document.getElementById('editBox').style.display = 'none';
  }
</script>
  
{% endblock %}
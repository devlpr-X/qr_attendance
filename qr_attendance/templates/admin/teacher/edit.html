{% extends "base.html" %}
{% block title %}Багш засах{% endblock %}

{% block content %}
<h2>Багш засах</h2>

{% if message %}
    <div style="padding:0.6rem; background:#e6f7ff; border-radius:6px; margin-bottom:1rem;">
        {{ message }}
    </div>
{% endif %}

<form method="POST" style="max-width:700px;">
    {% csrf_token %}
    <input type="hidden" name="user_id" value="{{ user.id }}">

    <div style="margin-bottom:0.75rem;">
        <label>И-мэйл:</label><br>
        <input type="email" name="email" required value="{{ user.email }}" style="width:100%; padding:0.5rem;">
    </div>

    <div style="margin-bottom:0.75rem;">
        <label>Нэр:</label><br>
        <input type="text" name="name" value="{{ user.name }}" style="width:100%; padding:0.5rem;">
    </div>

    <div style="margin-bottom:0.75rem;">
        <label><input type="checkbox" name="is_verified" {% if user.is_verified %}checked{% endif %}> Баталгаажсан</label>
    </div>

    <hr style="margin:1rem 0;">

    <h4>Нууц үг шинэчлэх</h4>
    <p style="margin-top:0;">Энд нууц үг оруулбал тэр нууц үгээр солигдоно. "Автомат үүсгэх" товч дарвал system санамсаргүй нууц үг үүсгэн бүртгэнэ.</p>

    <div style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem;">
        <input type="text" name="password" placeholder="Шинэ нууц үг (хоосон байж болно)" style="flex:1; padding:0.5rem;">
        <!-- автомат үүсгэх товч: JS нь form-д хэрэглэгч press хийвэл reset_generate=1 нэмнэ -->
        <button type="button" id="btnAutoGen" style="padding:0.5rem 0.8rem;">Автомат үүсгэх</button>
    </div>

    <div style="display:flex; gap:0.5rem; margin-top:0.8rem;">
        <button type="submit" style="padding:0.6rem 1rem;">Хадгалах</button>
        <a href="{% url 'admin_dashboard' %}"><button type="button" style="padding:0.6rem 1rem;">Буцах</button></a>
        <a href="{% url 'teacher_delete' user.id %}"><button type="button" style="background:#ef4444; color:white; padding:0.6rem 1rem;">Устгах</button></a>
    </div>

    <!-- hidden input for auto-generate flag -->
    <input type="hidden" name="reset_generate" id="reset_generate" value="0">
</form>

{% if new_password %}
    <div style="margin-top:1.2rem; padding:1rem; background:#f8fafc; border-radius:6px;">
        <h4>Шинэ нууц үг</h4>
        <p>Админ-д харуулагдаж байна. (DB-д plaintext хадгалаагүй)</p>
        <p style="font-family:monospace; font-size:1.05rem; display:inline-block; padding:0.4rem 0.6rem; background:white; border:1px solid #ddd;">
            <span id="generated-pass">{{ new_password }}</span>
            <button id="copyBtn" style="margin-left:0.6rem; padding:0.35rem 0.6rem;">Хуулах</button>
        </p>
    </div>
{% endif %}

<script>
document.getElementById('btnAutoGen').addEventListener('click', function(){
    // form доторх reset_generate=1 болгоод form-ыг submit хийх
    document.getElementById('reset_generate').value = '1';
    // жижиг visual: товчийг түрхэн дарч байгааг харуулна
    this.innerText = 'Үүсгэж байна...';
    this.disabled = true;
    // submit the form
    this.closest('form').submit();
});

// copy button
const copyBtn = document.getElementById('copyBtn');
if (copyBtn) {
    copyBtn.addEventListener('click', () => {
        const txt = document.getElementById('generated-pass').innerText;
        navigator.clipboard.writeText(txt).then(()=> {
            alert('Нууц үг хуулсан');
        });
    });
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}–•—É–≤–∞–∞—Ä—å - {{ semester.school_year }} {{ semester.term }}{% endblock %}

{% block content %}

<style>
  .schedule-header {
    background: linear-gradient(135deg, #667eea 0%, #5977f9 100%);
    color: white; padding: 1.6rem; border-radius: 8px; margin-bottom: 1.5rem;
  }
  .schedule-header h2 { margin: 0 0 0.4rem 0; }
  .schedule-header p { margin: 0.2rem 0; opacity: 0.95; }

  .section {
    background: white; padding: 1.2rem; border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 1.5rem;
  }
  .section h3 { margin-top: 0; color: #1d5ede; font-weight:700; margin-bottom:0.8rem; }

  .form-row { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:0.8rem; margin-bottom:0.8rem; }
  .form-group { display:flex; flex-direction:column; }
  .form-group label { font-weight:600; margin-bottom:0.25rem; color:#333; }
  .form-group input, .form-group select { padding:0.6rem; border:1px solid #e0e0e0; border-radius:6px; }

  .btn { padding:0.6rem 1rem; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
  .btn-primary { background:#1d5ede; color:white; }
  .btn-danger { background:#d32f2f; color:white; }
  .btn-success { background:#2e7d32; color:white; }

  .table-wrapper { overflow-x:auto; margin-top:0.6rem; }
  table { width:100%; border-collapse:collapse; }
  th, td { border:1px solid #eee; padding:0.6rem; vertical-align:top; text-align:left; font-size:0.95rem; }
  th { background:#fafafa; font-weight:700; text-align:center; }
  .slot-box { background:#f0f6ff; border-left:4px solid #1d5ede; padding:0.5rem; border-radius:4px; margin-bottom:6px;
  width: 160px; }
  .slot-box strong { display:block; }
  .empty-state { text-align:center; color:#888; padding:1rem; }
  
.btn-secondary {
  background: rgb(232, 225, 225);
  color: #576476;
  border: 1px solid #e5e7eb;
  padding: 0.65rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95rem;
  transition: all 0.2s;
}

</style>

<div class="schedule-header">
  <h2>  
    <a href="{% url 'semester_list' %}" class="btn-secondary" style="text-decoration: none;">
      ‚Üê
    </a>&nbsp;
    üìñ {{ semester.school_year }} –æ–Ω—ã {{ semester.term }}-—Ä —Å–µ–º–µ—Å—Ç—Ä–∏–π–Ω —Ö—É–≤–∞–∞—Ä—å
  </h2>

  <p>
    üè´ –°—É—Ä–≥—É—É–ª—å:
    {% comment %} Try to print location name matching semester.school_id {% endcomment %}
    {% if locations %}
      {% for loc in locations %}
        {% if loc.0 == semester.school_id %}
          {{ loc.1 }}
        {% endif %}
      {% endfor %}
      {% if not locations|length %}
        {{ semester.school_id }}
      {% endif %}
    {% else %}
      {{ semester.school_id }}
    {% endif %}
  </p>

  <p>üìÖ {{ semester.start_date }} - {{ semester.end_date }}</p>
</div>

<!-- ADD PATTERN -->
<div class="section">
  <h3>–®–∏–Ω—ç —Ö–∏—á—ç—ç–ª–∏–π–Ω —Ö—É–≤–∞–∞—Ä—å –Ω—ç–º—ç—Ö</h3>

  {% if error %}
    <div style="background:#ffefef; border-left:4px solid #f44336; padding:0.6rem; margin-bottom:0.8rem; color:#b71c1c;">
      ‚ö†Ô∏è {{ error }}
    </div>
  {% endif %}

  <form method="POST">
    {% csrf_token %}
    <input type="hidden" name="action" value="add_pattern">

    <div class="form-row">
      <div class="form-group">
        <label>–•–∏—á—ç—ç–ª</label>
        <select name="course_id" required>
          <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
          {% for c in courses %}
            <option value="{{ c.0 }}">{{ c.1 }} {% if c.2 %} ({{ c.2 }}){% endif %}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>–ë–∞–≥—à</label>
        <select name="teacher_id" required>
          <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
          {% for t in teachers %}
            <option value="{{ t.0 }}">{{ t.1 }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>”®–¥”©—Ä</label>
        <select name="day_of_week" required>
          <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
          <option value="0">–î–∞–≤–∞–∞</option>
          <option value="1">–ú—è–≥–º–∞—Ä</option>
          <option value="2">–õ—Ö–∞–≥–≤–∞</option>
          <option value="3">–ü“Ø—Ä—ç–≤</option>
          <option value="4">–ë–∞–∞—Å–∞–Ω</option>
          <option value="5">–ë—è–º–±–∞</option>
          <option value="6">–ù—è–º</option>
        </select>
      </div>
      <div class="form-group">
        <label>–¶–∞–≥ (–ø–∞—Ä)</label>
      
        <!-- Hidden timeslot text for DB -->
        <input type="hidden" name="timeslot" id="timeslot">
      
        <select name="time_setting_id" id="time_setting_id" required>
          <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
          {% for slot in timeslots %}
            <option value="{{ slot.id }}" data-slot="{{ slot.slot }}">
              {{ slot.name }} ‚Äî {{ slot.slot }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <script>
        document.getElementById('time_setting_id').addEventListener('change', function (e) {
          const opt = e.target.selectedOptions[0];
          document.getElementById('timeslot').value = opt.dataset.slot;
        });
      </script>
    </div>        

    <div class="form-row">
      <div class="form-group">
        <label>–•–∏—á—ç—ç–ª–∏–π–Ω —Ç”©—Ä”©–ª</label>
        <select name="lesson_type_id" required>
          <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
          {% for lt in lesson_types %}
            <option value="{{ lt.0 }}">{{ lt.2 }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>–ë–∞–π—Ä—à–∏–ª</label>
        <select name="location_id">
          <option value="">–ó–∞–∞–≥–∞–∞–≥“Ø–π</option>
          {% for l in locations %}
            <option value="{{ l.0 }}" {% if l.0 == semester.school_id %}selected{% endif %}>{{ l.1 }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>–î–∞–≤—Ç–∞–º–∂</label>
        <select name="frequency" required>
          <option value="1">7 —Ö–æ–Ω–æ–≥ –±“Ø—Ä</option>
          <option value="2">–°–æ–Ω–¥–≥–æ–π 7 —Ö–æ–Ω–æ–≥</option>
          <option value="3">–¢—ç–≥—à 7 —Ö–æ–Ω–æ–≥</option>
          <option value="3">2 7 —Ö–æ–Ω–æ–≥</option>
        </select>
      </div>
      <div class="form-group">
      </div>
    </div>

    <hr>
    <!-- ========================= -->
    <!-- ROOM TYPE + ROOM FILTER  -->
    <!-- ========================= -->
    <div class="form-row">
      <div class="form-group">
        <label>–¢–∞–Ω—Ö–∏–º —Ç”©—Ä”©–ª</label>
        <select id="room_type" required>
          <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
          {% for room_type in room_types %}
          <option value="{{ room_type.id }}">{{ room_type.name }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="room_type_id" id="room_type_id">
      </div>
  
      <script>
        function filterRooms(typeId) {
          const rooms = document.querySelectorAll("#class_room option");
          rooms.forEach(opt => {
            if (!opt.dataset.roomTypeId) return;
            opt.hidden = opt.dataset.roomTypeId !== typeId;
          });
  
          document.getElementById("class_room").value = "";
          document.getElementById("class_room_id").value = "";
          updateTotals();
        }
  
        document.getElementById("room_type").addEventListener("change", e => {
          document.getElementById("room_type_id").value = e.target.value;
          filterRooms(e.target.value);
        });
      </script>
  
      <div class="form-group">
        <label>–¢–∞–Ω—Ö–∏–º</label>
        <select id="class_room" required>
          <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
          {% for r in class_rooms %}
          <option 
              value="{{ r.id }}" 
              data-room-type-id="{{ r.room_type_id }}"
              data-capacity="{{ r.capacity }}"
          >
            {{ r.room_number }} ({{ r.capacity }})
          </option>
          {% endfor %}
        </select>
        <input type="hidden" name="class_room_id" id="class_room_id">
      </div>
  
      <script>
        document.getElementById("class_room").addEventListener("change", e => {
          document.getElementById("class_room_id").value = e.target.value;
          updateTotals();
        });
      </script>
    </div>
  
  
    <!-- ========================= -->
    <!-- PROGRAM + CLASS GROUP     -->
    <!-- ========================= -->
    <div class="form-row">
  
      <div class="form-group">
        <label>–•”©—Ç”©–ª–±”©—Ä</label>
        <select id="program" required>
          <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
          {% for program in programs %}
          <option value="{{ program.id }}">{{ program.name }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="program_id" id="program_id">
      </div>
  
      <script>
        document.getElementById("program").addEventListener("change", e => {
          const programId = e.target.value;
          document.getElementById("program_id").value = programId;
          filterClassGroups(programId);
        });
  
        function filterClassGroups(id) {
          const opts = document.querySelectorAll("#class_group option");
          opts.forEach(opt => {
            if (!opt.dataset.programId) return;
            opt.hidden = opt.dataset.programId !== id;
          });
  
          document.getElementById("class_group").value = "";
        }
      </script>
  
      <!-- CLASS GROUP MULTI-ADD -->
      <div class="form-group" style="width:100%;">
  
        <label id="group_label">
          –ë“Ø–ª—ç–≥ –Ω—ç–º—ç—Ö (<span id="total_students">0</span>/<span id="total_capacity">0</span>)
        </label>
  
        <select id="class_group">
          <option value="">–°–æ–Ω–≥–æ–Ω–æ —É—É</option>
          {% for r in class_groups %}
          <option 
              value="{{ r.id }}" 
              data-program-id="{{ r.program_id }}"
              data-students="{{ r.student_count }}"
          >
            {{ r.name }} ({{ r.student_count }})
          </option>
          {% endfor %}
        </select>
  
        <div id="selected_groups" style="margin-top:8px; display:flex; flex-direction:column; gap:4px;"></div>
  
      </div>
  
      <script>
        const selectedGroupsContainer = document.getElementById("selected_groups");
        const totalStudentsEl = document.getElementById("total_students");
        const totalCapacityEl = document.getElementById("total_capacity");
  
        document.getElementById("class_group").addEventListener("change", e => {
          const id = e.target.value;
          if (!id) return;
  
          if (document.getElementById("group_item_" + id)) return;
  
          const label = e.target.selectedOptions[0].textContent;
  
          const div = document.createElement("div");
          div.id = "group_item_" + id;
          div.style = `
            padding:6px;
            background:#f0f0f0;
            border-radius:6px;
            display:flex;
            justify-content:space-between;
            align-items:center;`;
  
          div.innerHTML = `
            <span>${label}</span>
            <button type="button" class="btn btn-danger" style="padding:2px 6px;" data-remove="${id}">x</button>
            <input type="hidden" name="class_group_ids[]" value="${id}">
          `;
  
          selectedGroupsContainer.appendChild(div);
  
          div.querySelector("button").addEventListener("click", () => {
            div.remove();
            updateTotals();
          });
  
          updateTotals();
        });
  
  
        function updateTotals() {
          // Capacity
          const roomOpt = document.querySelector("#class_room option:checked");
          let capacity = roomOpt?.dataset.capacity ? parseInt(roomOpt.dataset.capacity) : 0;
  
          totalCapacityEl.textContent = capacity || 0;
  
          // Students from groups
          const selected = document.querySelectorAll("input[name='class_group_ids[]']");
          let totalStudents = 0;
  
          selected.forEach(input => {
            const option = document.querySelector(`#class_group option[value='${input.value}']`);
            if (option?.dataset.students) {
              totalStudents += parseInt(option.dataset.students);
            }
          });
  
          totalStudentsEl.textContent = totalStudents;
  
          // warning color
          if (capacity && totalStudents > capacity) {
            totalStudentsEl.style.color = "red";
          } else {
            totalStudentsEl.style.color = "black";
          }
        }
      </script>
  
    </div>
  
    <div style="display:flex; gap:0.5rem; margin-top:0.6rem;">
      <button type="submit" class="btn btn-primary">–ù—ç–º—ç—Ö</button>
    </div>
  </form>

<!-- TIMETABLE (timeslots √ó days) -->
<div class="section">
  <h3>üìã –•–∏—á—ç—ç–ª–∏–π–Ω —Ö—É–≤–∞–∞—Ä—å (–¶–∞–≥ √ó ”®–¥”©—Ä)</h3>

  <div class="table-wrapper">
    <table class="timetable">
      <thead>
        <tr>
          <th style="width:140px;">–¶–∞–≥</th>
          <th>–î–∞–≤–∞–∞</th>
          <th>–ú—è–≥–º–∞—Ä</th>
          <th>–õ—Ö–∞–≥–≤–∞</th>
          <th>–ü“Ø—Ä—ç–≤</th>
          <th>–ë–∞–∞—Å–∞–Ω</th>
          <th>–ë—è–º–±–∞</th>
          <th>–ù—è–º</th>
        </tr>
      </thead>
      <tbody>
        {% if timeslots %}
          {% for slot in timeslots %}
            <tr>
              <td style="font-weight:700; text-align:center;   vertical-align: middle;">
                {{ slot.name }}<br><small style="color:#666;">{{ slot.slot }}</small>
              </td>

              {% comment %} loop days as characters '0'..'6' {% endcomment %}
              {% for day in "0123456" %}
              <td>
                {% for p in patterns %}
                  {# Use time_setting_id match instead of string timeslot comparison #}
                  {% if p.time_setting_id == slot.id and p.day_of_week|stringformat:"s" == day %}
                    <div class="slot-box">
                      <strong>{{ p.course }}</strong>
                      <small>{{ p.teacher }} –±–∞–≥—à</small><small>({{ p.lesson_type_name }})</small><br>
                      <small style="color:#666;">{{ p.frequency_text }}</small>

                      <form method="POST" style="margin-top:6px;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_pattern">
                        <input type="hidden" name="pattern_id" value="{{ p.id }}">
                        <button type="submit" class="btn btn-danger" style="padding:6px 8px; font-size:13px;"
                        onclick="return confirm('–≠–Ω—ç —Ö—É–≤–∞–∞—Ä—å–∏–π–≥ —É—Å—Ç–≥–∞—Ö —É—É?')">–£—Å—Ç–≥–∞—Ö</button>
                      </form>
                      <a href="{% url 'semester_list' %}"><button type="button" class="btn btn-primary" style="padding:6px 8px; font-size:13px;">–ë“Ø–ª—ç–≥ –±“Ø—Ä—Ç–≥—ç—Ö</button></a>
                    </div>
                  {% endif %}
                {% endfor %}
              </td>
            {% endfor %}

            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="8" class="empty-state">–¶–∞–≥–∏–π–Ω (–ø–∞—Ä) –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- LIST VIEW -->
<div class="section">
  <h3>üìã –ù—ç–º—ç–≥–¥—Å—ç–Ω —Ö–∏—á—ç—ç–ª–∏–π–Ω —Ö—É–≤–∞–∞—Ä—å (–ñ–∞–≥—Å–∞–∞–ª—Ç)</h3>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th style="width:40px;">‚Ññ</th>
          <th>–•–∏—á—ç—ç–ª</th>
          <th>–ë–∞–≥—à</th>
          <th>”®–¥”©—Ä</th>
          <th>–¶–∞–≥</th>
          <th>–¢”©—Ä”©–ª</th>
          <th>–î–∞–≤—Ç–∞–º–∂</th>
          <th style="width:120px;">“Æ–π–ª–¥—ç–ª</th>
        </tr>
      </thead>
      <tbody>
        {% if patterns %}
          {% for p in patterns %}
            
          <tr>
              <td>{{ forloop.counter }}</td>
              <td><strong>{{ p.course }}</strong><br><small style="color:#777;">{{ p.course_code }}</small></td>
              <td>{{ p.teacher }}</td>
              <td>{{ p.day }}</td>
              <td>{{ p.timeslot }}</td>
              <td>{{ p.lesson_type_name }}</td>
              <td>{{ p.frequency_text }}</td>
              <td>
                <form method="POST" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete_pattern">
                  <input type="hidden" name="pattern_id" value="{{ p.id }}">
                  <button type="submit" class="btn btn-danger" onclick="return confirm('–£—Å—Ç–≥–∞—Ö —É—É?')">–£—Å—Ç–≥–∞—Ö</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="8" class="empty-state">–•—É–≤–∞–∞—Ä—å –Ω—ç–º—ç–≥–¥—ç—ç–≥“Ø–π –±–∞–π–Ω–∞</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

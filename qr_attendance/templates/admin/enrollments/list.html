
	
	{% extends "base.html" %}
  {% load static %}
  
  {% block title %}–≠–ª—Å—ç–ª—Ç“Ø“Ø–¥{% endblock %}
  
  {% block content %}
  <link rel="stylesheet" href="{% static 'css/table_data.css' %}">
  
  <div style="max-width:1600px; margin:0 auto; padding:20px;">
  {% comment %}
  <!-- Messages -->
  <!-- {% if messages %}
      {% for message in messages %}
        <div class="alert-{{ message.tags }}" style="margin-bottom:1rem; padding:0.8rem; border-radius:8px; 
             {% if message.tags == 'success' %}background:#d1fae5; color:#065f46;{% elif message.tags == 'error' %}background:#fee2e2; color:#991b1b;{% else %}background:#fef3c7; color:#92400e;{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %} -->
  {% endcomment %}
    
    <!-- ==================== –ë“Æ–õ–ì–≠–≠–† –≠–õ–°“Æ“Æ–õ–≠–• ==================== -->
    <h2 style="color:#0b2e78; margin-bottom:1rem;">–ë“Ø–ª–≥—ç—ç—Ä —Ö–∏—á—ç—ç–ª–¥ —ç–ª—Å“Ø“Ø–ª—ç—Ö</h2>
  
    <div style="background:white; padding:1.5rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.07); margin-bottom:2rem;">
      <form method="POST" id="enrollGroupForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="enroll_group">
  
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
          
          <div class="form-group">
            <label>–°—É—Ä–≥—É—É–ª—å</label>
            <select id="groupSchool" style="width:100%;">
              <option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>
              {% for s in schools %}
                <option value="{{ s.id }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>
  
          <div class="form-group">
            <label>–°–µ–º–µ—Å—Ç–µ—Ä</label>
            <select id="groupSemester" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
            </select>
          </div>
  
          <div class="form-group">
            <label>–¢—ç–Ω—Ö–∏–º</label>
            <select id="groupDepartment" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
            </select>
          </div>
  
          <div class="form-group">
            <label>–ê–Ω–≥–∏ –±“Ø–ª—ç–≥ <span style="color:#dc2626;">*</span></label>
            <select id="groupClassGroup" name="class_group_id" required style="width:100%;">
              <option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>
            </select>
          </div>
  
          <div class="form-group">
            <label>–•–∏—á—ç—ç–ª <span style="color:#dc2626;">*</span></label>
            <select id="groupCourse" name="course_id" required style="width:100%;">
              <option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>
              {% for c in courses %}
                <option value="{{ c.id }}">{{ c.code }} - {{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
  
        <div style="display:flex; gap:1rem; align-items:center;">
          <button type="submit" class="btn-primary" style="padding:0.8rem 2rem;">
            ‚ûú –ë“Ø–ª–≥–∏–π–Ω –±“Ø—Ö –æ—é—É—Ç–Ω—ã–≥ —ç–ª—Å“Ø“Ø–ª—ç—Ö
          </button>
          <span style="color:#6b7280; font-size:0.9rem;">
            –¢—É—Ö–∞–π–Ω –∞–Ω–≥–∏–¥ –±“Ø—Ä—Ç–≥—ç–ª—Ç—ç–π –±“Ø—Ö –æ—é—É—Ç–∞–Ω —ç–Ω—ç —Ö–∏—á—ç—ç–ª–¥ —ç–ª—Å—ç–Ω—ç
          </span>
        </div>
      </form>
    </div>
  
    <!-- ==================== –ù–≠–ú–≠–õ–¢ –û–Æ–£–¢–ê–ù –ù–≠–ú–≠–• ==================== -->
    <h2 style="color:#0b2e78; margin-bottom:1rem;">–ù—ç–º—ç–ª—Ç –æ—é—É—Ç–∞–Ω —ç–ª—Å“Ø“Ø–ª—ç—Ö</h2>
  
    <div style="background:white; padding:1.5rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.07); margin-bottom:3rem;">
      <form method="POST" id="enrollAdditionalForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="enroll_additional">
  
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
          
          <div class="form-group">
            <label>–°—É—Ä–≥—É—É–ª—å</label>
            <select id="addSchool" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
              {% for s in schools %}
                <option value="{{ s.id }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>
  
          <div class="form-group">
            <label>–°–µ–º–µ—Å—Ç–µ—Ä</label>
            <select id="addSemester" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
            </select>
          </div>
  
          <div class="form-group">
            <label>–¢—ç–Ω—Ö–∏–º</label>
            <select id="addDepartment" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
            </select>
          </div>
  
          <div class="form-group">
            <label>–ê–Ω–≥–∏ –±“Ø–ª—ç–≥ <span style="color:#dc2626;">*</span></label>
            <select id="addClassGroup" name="class_group_id" required style="width:100%;">
              <option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>
            </select>
          </div>
  
          <div class="form-group">
            <label>–•–∏—á—ç—ç–ª <span style="color:#dc2626;">*</span></label>
            <select id="addCourse" name="course_id" required style="width:100%;">
              <option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>
              {% for c in courses %}
                <option value="{{ c.id }}">{{ c.code }} - {{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
  
        <!-- –û—é—É—Ç–∞–Ω —Ö–∞–π–ª—Ç -->
        <div style="margin-bottom:1rem;">
          <label style="font-weight:600;">–û—é—É—Ç–∞–Ω —Ö–∞–π—Ö</label>
          <input id="studentFilter" type="text" placeholder="–ö–æ–¥ —ç—Å–≤—ç–ª –Ω—ç—Ä..." 
                 style="width:100%; padding:0.7rem; border-radius:8px; border:1px solid #e5e7eb;">
        </div>
  
        <!-- –¢–æ–≤—á–ª—É—É—Ä -->
        <div style="display:flex; gap:1rem; margin-bottom:1rem; align-items:center; flex-wrap:wrap;">
          <button type="button" id="selectAllBtn" class="btn-secondary">‚úì –ë“Ø–≥–¥–∏–π–≥ —Å–æ–Ω–≥–æ—Ö</button>
          <button type="button" id="deselectAllBtn" class="btn-secondary">‚úó –ë“Ø–≥–¥–∏–π–≥ —Ü—É—Ü–ª–∞—Ö</button>
          
          <div style="color:#6b7280; font-size:0.95rem;">
            <strong id="visibleCount">0</strong> —Ö–∞—Ä–∞–≥–¥–∞–∂ –±–∞–π–Ω–∞ ‚Ä¢ 
            <strong id="selectedCount">0</strong> —Å–æ–Ω–≥–æ–≥–¥–ª–æ–æ
          </div>
  
          <button type="submit" class="btn-primary" style="margin-left:auto;">
            ‚ûú –°–æ–Ω–≥–æ—Å–æ–Ω –æ—é—É—Ç–Ω—É—É–¥—ã–≥ —ç–ª—Å“Ø“Ø–ª—ç—Ö
          </button>
        </div>
  
        <!-- –û—é—É—Ç–Ω—ã –∂–∞–≥—Å–∞–∞–ª—Ç -->
        <div style="max-height:400px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; background:#fafafa;">
          <table style="width:100%;">
            <tbody id="studentTableBody">
              <tr><td style="padding:2rem; text-align:center; color:#9ca3af;">–ê–Ω–≥–∏ –±“Ø–ª—ç–≥ –±–∞ —Ö–∏—á—ç—ç–ª —Å–æ–Ω–≥–æ–Ω–æ —É—É</td></tr>
            </tbody>
          </table>
        </div>
      </form>
    </div>
  
    <!-- ==================== –≠–õ–°–≠–õ–¢–ò–ô–ù –ñ–ê–ì–°–ê–ê–õ–¢ ==================== -->
    <div id="results">
      <h2 style="color:#0b2e78; margin-bottom:1rem;">–≠–ª—Å—ç–ª—Ç–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç</h2>
  
      <!-- –®“Æ“Æ–õ–¢ -->
      <div style="background:white; padding:1.2rem; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:1.5rem;">
        <form method="GET" id="filterForm">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1rem;">
            
            <div class="form-group">
              <label>–•–∞–π–ª—Ç</label>
              <input type="text" name="search" value="{{ search }}" placeholder="–ö–æ–¥, –Ω—ç—Ä..." style="width:100%;">
            </div>
  
            <div class="form-group">
              <label>–°—É—Ä–≥—É—É–ª—å</label>
              <select name="school_id" id="filterSchool" style="width:100%;">
                <option value="">–ë“Ø–≥–¥</option>
                {% for s in schools %}
                  <option value="{{ s.id }}" {% if filter_school == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>
  
            <div class="form-group">
              <label>–°–µ–º–µ—Å—Ç–µ—Ä</label>
              <select name="semester_id" id="filterSemester" style="width:100%;">
                <option value="">–ë“Ø–≥–¥</option>
              </select>
            </div>
  
            <div class="form-group">
              <label>–¢—ç–Ω—Ö–∏–º</label>
              <select name="department_id" id="filterDepartment" style="width:100%;">
                <option value="">–ë“Ø–≥–¥</option>
              </select>
            </div>
  
            <div class="form-group">
              <label>–ê–Ω–≥–∏</label>
              <select name="class_group_id" id="filterClassGroup" style="width:100%;">
                <option value="">–ë“Ø–≥–¥</option>
              </select>
            </div>
  
            <div class="form-group">
              <label>–•–∏—á—ç—ç–ª</label>
              <select name="course_id" style="width:100%;">
                <option value="">–ë“Ø–≥–¥</option>
                {% for c in courses %}
                  <option value="{{ c.id }}" {% if filter_course == c.id|stringformat:"s" %}selected{% endif %}>
                    {{ c.code }} - {{ c.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
  
            <div class="form-group">
              <label>–•—É—É–¥—Å–∞–Ω–¥</label>
              <select name="per_page" style="width:100%;">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                <option value="30" {% if per_page == 30 %}selected{% endif %}>30</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              </select>
            </div>
          </div>
  
          <div style="display:flex; gap:0.7rem; align-items:center;">
            <button type="submit" class="btn-primary">–®“Ø“Ø—Ö</button>
            <a href="?" class="btn-secondary" style="text-decoration:none;">–¶—ç–≤—ç—Ä–ª—ç—Ö</a>
            <span style="margin-left:auto; color:#6b7280;">–ù–∏–π—Ç: <strong>{{ paginator.count }}</strong></span>
          </div>
        </form>
      </div>
  
      <!-- TABLE -->
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th style="width:60px;">‚Ññ</th>
              <th>–ö–æ–¥</th>
              <th>–û—é—É—Ç–∞–Ω</th>
              <th>–•–∏—á—ç—ç–ª</th>
              <th>–ê–Ω–≥–∏</th>
              <th>–¢—ç–Ω—Ö–∏–º</th>
              <th>–°–µ–º–µ—Å—Ç–µ—Ä</th>
              <th>–°—É—Ä–≥—É—É–ª—å</th>
              <th style="width:100px; text-align:center;">“Æ–π–ª–¥—ç–ª</th>
            </tr>
          </thead>
          <tbody>
            {% for e in enrolls %}
            <tr>
              <td>{{ e.number }}</td>
              <td><strong>{{ e.student_code }}</strong></td>
              <td>{{ e.student_name }}</td>
              <td><code style="background:#f1f5f9; padding:0.2rem 0.5rem; border-radius:4px;">{{ e.course_code }}</code> {{ e.course_name }}</td>
              <td><span class="badge">{{ e.class_group_name }}</span></td>
              <td>{{ e.department_name }}</td>
              <td>{{ e.semester_name }}</td>
              <td>{{ e.school_name }}</td>
              <td style="text-align:center;">
                <a href="{% url 'enrollment_delete' e.id %}">
                  <button onclick="return confirm('–£—Å—Ç–≥–∞—Ö —É—É?')" class="btn-secondary" 
                          style="background:#fee; color:#dc2626; border-color:#fca5a5; padding:0.4rem 0.7rem;">
                    üóëÔ∏è
                  </button>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="9" style="padding:2rem; text-align:center; color:#9ca3af;">–≠–ª—Å—ç–ª—Ç –æ–ª–¥—Å–æ–Ω–≥“Ø–π</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  
      <!-- PAGINATION -->
      {% if paginator.num_pages > 1 %}
      <div class="pagination" style="margin-top:1.5rem;">
        {% if page_obj.has_previous %}
          <a href="?page=1&{{ request.GET.urlencode }}&scroll=1" class="pg-btn">¬´</a>
          <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}&scroll=1" class="pg-btn">‚Äπ</a>
        {% endif %}
  
        <span style="padding:0.5rem 1rem; background:#1d5ede; color:white; border-radius:6px;">
          {{ page_obj.number }} / {{ paginator.num_pages }}
        </span>
  
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}&scroll=1" class="pg-btn">‚Ä∫</a>
          <a href="?page={{ paginator.num_pages }}&{{ request.GET.urlencode }}&scroll=1" class="pg-btn">¬ª</a>
        {% endif %}
      </div>
      {% endif %}
  
    </div>
  
  </div>
  
  <style>
  .pg-btn {
    padding:0.5rem 0.9rem;
    background:white;
    border-radius:6px;
    text-decoration:none;
    color:#334155;
    border:1px solid #e2e8f0;
    display:inline-block;
  }
  .pg-btn:hover { background:#f1f5f9; }
  .student-row:hover { background:#eef4ff; }
  .student-row { cursor:pointer; transition:background 0.15s; }
  </style>
  
  <script>
  const djangoSchools = '{{ schools_json|escapejs }}';
  const djangoSemesters = '{{ semesters_json|escapejs }}';
  const djangoDepartments = '{{ departments_json|escapejs }}';
  const djangoClassGroups = '{{ class_groups_json|escapejs }}';
  const djangoCourses = '{{ courses_json|escapejs }}';
  const djangoStudents = '{{ students_json|escapejs }}';
  
  const schoolsData = djangoSchools ? JSON.parse(djangoSchools) : [];
  const semestersData = djangoSemesters ? JSON.parse(djangoSemesters) : [];
  const departmentsData = djangoDepartments ? JSON.parse(djangoDepartments) : [];
  const classGroupsData = djangoClassGroups ? JSON.parse(djangoClassGroups) : [];
  const coursesData = djangoCourses ? JSON.parse(djangoCourses) : [];
  const studentsData = djangoStudents ? JSON.parse(djangoStudents) : [];
  
  let enrolledStudentIds = [];
  let filteredStudents = [];
  
  /* ========================
     HELPER FUNCTIONS
  ======================== */
  function populateSemesters(selectId, schoolId, selectedId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    const sems = semestersData.filter(s => !schoolId || String(s.school_id) === String(schoolId));
    select.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
      sems.map(s => {
        const label = s.name || `${s.school_year}-${s.term}`;
        const sel = String(s.id) === String(selectedId || '') ? 'selected' : '';
        return `<option value="${s.id}" ${sel}>${escapeHtml(label)}</option>`;
      }).join('');
  }
  
  function populateDepartments(selectId, schoolId, selectedId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    const depts = departmentsData.filter(d => !schoolId || String(d.school_id) === String(schoolId));
    select.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
      depts.map(d => {
        const sel = String(d.id) === String(selectedId || '') ? 'selected' : '';
        return `<option value="${d.id}" ${sel}>${escapeHtml(d.name)}</option>`;
      }).join('');
  }
  
  function populateClassGroups(selectId, schoolId, semesterId, departmentId, selectedId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    let groups = classGroupsData;
    if (schoolId) groups = groups.filter(g => String(g.school_id) === String(schoolId));
    if (semesterId) groups = groups.filter(g => String(g.semester_id || '') === String(semesterId));
    if (departmentId) groups = groups.filter(g => String(g.department_id || '') === String(departmentId));
    
    select.innerHTML = '<option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>' +
      groups.map(g => {
        const sel = String(g.id) === String(selectedId || '') ? 'selected' : '';
        return `<option value="${g.id}" ${sel}>${escapeHtml(g.name)}</option>`;
      }).join('');
  }
  
  /* ========================
     GROUP ENROLL FORM
  ======================== */
  const groupSchool = document.getElementById('groupSchool');
  const groupSemester = document.getElementById('groupSemester');
  const groupDepartment = document.getElementById('groupDepartment');
  const groupClassGroup = document.getElementById('groupClassGroup');
  
  groupSchool.addEventListener('change', () => {
    const sid = groupSchool.value || null;
    populateSemesters('groupSemester', sid, null);
    populateDepartments('groupDepartment', sid, null);
    populateClassGroups('groupClassGroup', sid, null, null, null);
  });
  
  groupSemester.addEventListener('change', () => {
    populateClassGroups('groupClassGroup', groupSchool.value, groupSemester.value, groupDepartment.value, null);
  });
  
  groupDepartment.addEventListener('change', () => {
    populateClassGroups('groupClassGroup', groupSchool.value, groupSemester.value, groupDepartment.value, null);
  });
  
  /* ========================
     ADD STUDENTS FORM
  ======================== */
  const addSchool = document.getElementById('addSchool');
  const addSemester = document.getElementById('addSemester');
  const addDepartment = document.getElementById('addDepartment');
  const addClassGroup = document.getElementById('addClassGroup');
  const addCourse = document.getElementById('addCourse');
  const studentTableBody = document.getElementById('studentTableBody');
  const studentFilter = document.getElementById('studentFilter');
  const visibleCount = document.getElementById('visibleCount');
  const selectedCount = document.getElementById('selectedCount');
  
  addSchool.addEventListener('change', () => {
    const sid = addSchool.value || null;
    populateSemesters('addSemester', sid, null);
    populateDepartments('addDepartment', sid, null);
    populateClassGroups('addClassGroup', sid, null, null, null);
    loadStudentsForAdding();
  });
  
  addSemester.addEventListener('change', () => {
    populateClassGroups('addClassGroup', addSchool.value, addSemester.value, addDepartment.value, null);
  });
  
  addDepartment.addEventListener('change', () => {
    populateClassGroups('addClassGroup', addSchool.value, addSemester.value, addDepartment.value, null);
  });
  
  addClassGroup.addEventListener('change', loadStudentsForAdding);
  addCourse.addEventListener('change', loadStudentsForAdding);
  studentFilter.addEventListener('input', renderStudents);
  
  async function loadStudentsForAdding() {
    const cgId = addClassGroup.value;
    const courseId = addCourse.value;
    
    if (!cgId || !courseId) {
      filteredStudents = [];
      enrolledStudentIds = [];
      renderStudents();
      return;
    }
    
    // Fetch students in class group
    try {
      const response = await fetch(`/api/assigned-students/?class_group_id=${cgId}`);
      const data = await response.json();
      const classGroupStudentIds = data.student_ids || [];
      
      // Fetch already enrolled students
      const enrollResponse = await fetch(`/api/enrolled-students/?course_id=${courseId}&class_group_id=${cgId}`);
      const enrollData = await enrollResponse.json();
      enrolledStudentIds = enrollData.student_ids || [];
      
      // Filter students
      filteredStudents = studentsData.filter(s => classGroupStudentIds.includes(s.id));
      
    } catch (error) {
      console.error('Failed to fetch students:', error);
      filteredStudents = [];
      enrolledStudentIds = [];
    }
    
    renderStudents();
  }
  
  function renderStudents() {
    const searchQ = (studentFilter.value || '').toLowerCase();
    
    const displayed = filteredStudents.filter(s => {
      const text = `${s.student_code} ${s.full_name}`.toLowerCase();
      return !searchQ || text.includes(searchQ);
    });
    
    if (displayed.length === 0) {
      studentTableBody.innerHTML = '<tr><td style="padding:2rem; text-align:center; color:#9ca3af;">–û—é—É—Ç–∞–Ω –æ–ª–¥—Å–æ–Ω–≥“Ø–π</td></tr>';
    } else {
      studentTableBody.innerHTML = displayed.map(s => {
        const isEnrolled = enrolledStudentIds.includes(s.id);
        const checkedAttr = isEnrolled ? 'checked' : '';
        const rowStyle = isEnrolled ? 'background:#f0fdf4;' : '';
        
        return `
          <tr class="student-row" style="${rowStyle}">
            <td style="padding:0.6rem;">
              <label style="cursor:pointer; display:flex; align-items:center;">
                <input class="student-checkbox" type="checkbox" name="student_ids" value="${s.id}" ${checkedAttr}>
                <span style="margin-left:0.7rem;">
                  <strong>${escapeHtml(s.student_code)}</strong> - ${escapeHtml(s.full_name)}
                  ${isEnrolled ? '<span style="color:#10b981; font-size:0.85rem; margin-left:0.5rem;">‚úì –≠–ª—Å—Å—ç–Ω</span>' : ''}
                </span>
              </label>
            </td>
          </tr>
        `;
      }).join('');
      
      document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.addEventListener('change', updateCounters);
      });
    }
    
    updateCounters();
  }
  
  function updateCounters() {
    visibleCount.textContent = filteredStudents.length;
    selectedCount.textContent = document.querySelectorAll('.student-checkbox:checked').length;
  }
  
  document.getElementById('selectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = true);
    updateCounters();
  });
  
  document.getElementById('deselectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
    updateCounters();
  });
  
  /* ========================
     FILTER SECTION
  ======================== */
  const filterSchool = document.getElementById('filterSchool');
  const filterSemester = document.getElementById('filterSemester');
  const filterDepartment = document.getElementById('filterDepartment');
  const filterClassGroup = document.getElementById('filterClassGroup');
  
  populateSemesters('filterSemester', '{{ filter_school }}', '{{ filter_semester }}');
  populateDepartments('filterDepartment', '{{ filter_school }}', '{{ filter_department }}');
  populateClassGroups('filterClassGroup', '{{ filter_school }}', '{{ filter_semester }}', '{{ filter_department }}', '{{ filter_class_group }}');
  
  filterSchool.addEventListener('change', () => {
    const sid = filterSchool.value || null;
    populateSemesters('filterSemester', sid, null);
    populateDepartments('filterDepartment', sid, null);
    populateClassGroups('filterClassGroup', sid, null, null, null);
  });
  
  filterSemester.addEventListener('change', () => {
    populateClassGroups('filterClassGroup', filterSchool.value, filterSemester.value, filterDepartment.value, null);
  });
  
  filterDepartment.addEventListener('change', () => {
    populateClassGroups('filterClassGroup', filterSchool.value, filterSemester.value, filterDepartment.value, null);
  });
  
  /* ========================
     SCROLL TO RESULTS
  ======================== */
  document.addEventListener("DOMContentLoaded", function () {
    if (window.location.search.includes("scroll=1")) {
      const target = document.getElementById("results");
      if (target) {
        setTimeout(() => {
          window.scrollTo({
            top: target.offsetTop - 80,
            behavior: "smooth"
          });
        }, 150);
      }
    }
  });
  
  function escapeHtml(t) {
    const div = document.createElement('div');
    div.textContent = t == null ? '' : t;
    return div.innerHTML;
  }
  </script>
  
  {% endblock %}
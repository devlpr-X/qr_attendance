{% extends "base.html" %}
{% block title %}QR –£–Ω—à—É—É–ª–∞—Ö - {{ session.course_name|default:"–ò—Ä—Ü –±“Ø—Ä—Ç–≥—ç—Ö" }}{% endblock %}
{% block content %}
<style>
    .attendance-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    .header-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .header-info h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
    }
    .header-info p {
        margin: 0.3rem 0;
        opacity: 0.95;
    }
    .input-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    .input-section label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
    }
    .input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    #student_code {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }
    #student_code:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    button {
        padding: 0.8rem 1.5rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        transition: background 0.3s;
    }
    button:hover {
        background: #5568d3;
    }
    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    .location-info {
        background: #f0f4f8;
        padding: 1rem;
        border-left: 4px solid #4facfe;
        border-radius: 4px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }
    .location-info strong {
        color: #333;
    }
    .status-message {
        padding: 1rem;
        border-radius: 6px;
        margin-top: 1rem;
        text-align: center;
        font-weight: 600;
        display: none;
    }
    .status-message.loading {
        display: block;
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #90caf9;
    }
    .status-message.error {
        display: block;
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef5350;
    }
    .status-message.success {
        display: block;
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #66bb6a;
    }
    .info-box {
        background: #fff9c4;
        padding: 1rem;
        border-left: 4px solid #fbc02d;
        border-radius: 4px;
        margin-bottom: 1rem;
    }
    .info-box strong {
        color: #f57f17;
    }
    .error-box {
        background: #ffebee;
        padding: 1.5rem;
        border-left: 4px solid #ef5350;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .error-box h3 {
        color: #c62828;
        margin: 0 0 0.5rem 0;
    }
    .buttons-group {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    .btn-secondary {
        background: #6c757d;
        flex: 1;
    }
    .btn-secondary:hover {
        background: #5a6268;
    }
    .hidden {
        display: none !important;
    }
    .timer {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.5rem;
    }
</style>

<div class="attendance-container"
     data-has-session="{% if session %}1{% else %}0{% endif %}"
     data-token="{% if session %}{{ session.token }}{% endif %}"
     data-expires-at="{% if session and session.expires_at %}{{ session.expires_at|date:'c' }}{% endif %}">
    {% if error %}
        <div class="error-box">
            <h3>‚ö†Ô∏è –ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞</h3>
            <p>{{ error }}</p>
        </div>
        <div class="buttons-group">
            <button type="button" class="btn-secondary" onclick="history.back()">‚óÄÔ∏è –ë—É—Ü–∞—Ö</button>
        </div>
    {% elif session %}
        <div class="header-info">
            <h2>{{ session.course_name }}</h2>
            <p><strong>–ö–æ–¥:</strong> {{ session.course_code }}</p>
            <p><strong>–û–≥–Ω–æ–æ:</strong> {{ session.date }}</p>
            <p><strong>–¶–∞–≥:</strong> {{ session.timeslot|default:"–ó–∞–∞–≥–∞–∞–≥“Ø–π" }}</p>
            <p><strong>–¢”©—Ä”©–ª:</strong> {{ session.lesson_type|default:"–ó–∞–∞–≥–∞–∞–≥“Ø–π" }}</p>
        </div>

        {% if location %}
            <div class="location-info">
                üìç <strong>–ë–∞–π—Ä—à–∏–ª:</strong> {{ location.name }} (–†–∞–¥–∏—É—Å: {{ location.radius_m }} –º)<br>
                <small>–¢–∞ —ç–Ω—ç –±–∞–π—Ä—à–∏–ª–¥ –±–∞–π—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π</small>
            </div>
        {% else %}
            <div class="info-box">
                ‚ÑπÔ∏è <strong>–ê–Ω—Ö–∞–∞—Ä–Ω–∞ —É—É:</strong> –≠–Ω—ç session-–¥ –±–∞–π—Ä—à–ª—ã–Ω —Ö—è–∑–≥–∞–∞—Ä–ª–∞–ª—Ç –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.
            </div>
        {% endif %}

        <div class="input-section">
            <label for="student_code">–û—é—É—Ç–Ω—ã –∫–æ–¥:</label>
            <div class="input-group">
                <input
                    type="text"
                    id="student_code"
                    placeholder="–û—é—É—Ç–Ω—ã –∫–æ–¥—ã–≥ –æ—Ä—É—É–ª–Ω–∞"
                    autocomplete="off"
                    autofocus
                />
                <button type="button" id="btnSubmit">–ò–ª–≥—ç—ç—Ö</button>
            </div>
            <div class="timer" id="timer"></div>
            <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                Enter —Ç–æ–≤—á –¥–∞—Ä–∂ —ç—Å–≤—ç–ª —Ç–æ–≤—á–ª—É—É—Ä—ã–≥ –¥–∞—Ä–Ω–∞
            </p>
        </div>

        <div id="status" class="status-message"></div>

        <div class="buttons-group hidden" id="actionButtons">
            <button type="button" class="btn-secondary" onclick="location.reload()">üîÑ –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ—Ö</button>
        </div>
    {% else %}
        <div class="error-box">
            <h3>‚ö†Ô∏è Session –æ–ª–¥—Å–æ–Ω–≥“Ø–π</h3>
            <p>–•“Ø—Å—ç–ª—Ç –±—É—Ä—É—É —ç—Å–≤—ç–ª —Ö—É–≥–∞—Ü–∞–∞ –¥—É—É—Å—Å–∞–Ω –±–∞–π–Ω–∞.</p>
        </div>
    {% endif %}
</div>

<script>
(function () {
    const container = document.querySelector('.attendance-container');
    if (!container) {
        console.error('attendance container –æ–ª–¥—Å–æ–Ω–≥“Ø–π');
        return;
    }

    const hasSession = container.dataset.hasSession === '1';
    if (!hasSession) {
        console.error('Session –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞');
        return;
    }

    const token = container.dataset.token || '';
    const expiresAtStr = container.dataset.expiresAt || '';

    const studentInput = document.getElementById('student_code');
    const btn = document.getElementById('btnSubmit');
    const status = document.getElementById('status');
    const actionButtons = document.getElementById('actionButtons');

    if (!studentInput || !btn || !status) {
        console.error('HTML elements –æ–ª–¥—Å–æ–Ω–≥“Ø–π');
        return;
    }

    let submitTimeout = null;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    function getDeviceId(){
        try {
            let id = localStorage.getItem('device_id_attendance');
            if(!id){
                id = 'dev-' + Math.random().toString(36).slice(2,11) + '-' + Date.now().toString(36);
                localStorage.setItem('device_id_attendance', id);
            }
            return id;
        } catch (e) {
            console.warn('localStorage –¥–æ—Å—Ç—É–ø–≥“Ø–π:', e);
            return 'dev-' + Math.random().toString(36).slice(2,11);
        }
    }

    function getCookie(name) {
        const v = document.cookie.match("(^|;)\\s*" + name + "\\s*=\\s*([^;]+)");
        return v ? v.pop() : '';
    }

    function showStatus(message, type) {
        status.textContent = message;
        status.className = 'status-message ' + type;
        status.style.display = 'block';
    }

    function submitAttendance(student_code){
        if(submitTimeout) clearTimeout(submitTimeout);

        showStatus('üìç –ë–∞–π—Ä—à–∏–ª –∞–≤—á –±–∞–π–Ω–∞...', 'loading');
        studentInput.disabled = true;
        btn.disabled = true;

        if(!navigator.geolocation){
            showStatus('‚ùå –ë—Ä–∞—É–∑–µ—Ä –±–∞–π—Ä—à–∏–ª –¥—ç–º–∂–∏—Ö–≥“Ø–π –±–∞–π–Ω–∞', 'error');
            studentInput.disabled = false;
            btn.disabled = false;
            if (actionButtons) actionButtons.classList.remove('hidden');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function(pos){
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const device_id = getDeviceId();
                const device_info = navigator.userAgent || '';

                showStatus('üîÑ –ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞...', 'loading');

                const fd = new FormData();
                fd.append('student_code', student_code);
                fd.append('lat', lat);
                fd.append('lon', lon);
                fd.append('device_id', device_id);
                fd.append('device_info', device_info);

                fetch('/attendance/' + token + '/submit/', {
                    method: 'POST',
                    body: fd,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(function(r){
                    if(!r.ok) {
                        throw new Error('HTTP ' + r.status + ': ' + r.statusText);
                    }
                    return r.json();
                })
                .then(function(data){
                    if (data.ok) {
                        let msg = data.message || '–ê–º–∂–∏–ª—Ç—Ç–∞–π!';
                        if (data.student_name) msg += ' (' + data.student_name + ')';
                        if (data.distance_m !== undefined && data.distance_m !== null) {
                            msg += ' - –ó–∞–π: ' + data.distance_m + '–º';
                        }
                        showStatus(msg, 'success');
                        studentInput.value = '';
                        retryCount = 0;
                    } else {
                        let err = data.error || '–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞';
                        if (data.student_name) err += ' (' + data.student_name + ')';
                        if (data.distance_m !== undefined && data.distance_m !== null) {
                            err += ' - –ó–∞–π: ' + data.distance_m + '–º';
                        }
                        showStatus(err, 'error');
                    }
                    studentInput.disabled = false;
                    btn.disabled = false;
                    studentInput.focus();
                    if (actionButtons) actionButtons.classList.remove('hidden');
                })
                .catch(function(e){
                    retryCount++;
                    console.error('Fetch error:', e);

                    if(retryCount < MAX_RETRIES){
                        showStatus('‚ö†Ô∏è –ê–ª–¥–∞–∞: ' + e.message + '. ' + (MAX_RETRIES - retryCount) + ' —É–¥–∞–∞ –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ—Ö –±–æ–ª–æ–º–∂—Ç–æ–π...', 'error');
                        studentInput.disabled = false;
                        btn.disabled = false;
                        studentInput.focus();
                    } else {
                        showStatus('‚ùå –°–µ—Ä–≤–µ—Ä—ç—ç—Å —Ö–∞—Ä–∏—É –∞–≤–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π –±–∞–π–Ω–∞. –ê–¥–º–∏–Ω-—Ç–∞–π —Ö–æ–ª–±–æ–≥–¥–æ–Ω–æ —É—É.', 'error');
                        if (actionButtons) actionButtons.classList.remove('hidden');
                        studentInput.disabled = false;
                        btn.disabled = false;
                    }
                });
            },
            function(err){
                console.error('Geolocation error:', err);
                let msg = '–ë–∞–π—Ä—à–∏–ª –∞–≤–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π';

                if(err && err.code === 1){
                    msg = '–ë–∞–π—Ä—à–ª—ã–≥ –∑”©–≤—à”©”©—Ä”©”©–≥“Ø–π –±–∞–π–Ω–∞. –ë—Ä–∞—É–∑–µ—Ä –¥—ç—ç—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–Ω–∞ —É—É.';
                } else if(err && err.code === 3){
                    msg = '–ë–∞–π—Ä—à–∏–ª –∞–≤–∞—Ö “Ø–µ–¥ —Ö—É–≥–∞—Ü–∞–∞ —Ö—ç—Ç—ç—Ä–ª—ç—ç.';
                } else if(err && err.code === 2){
                    msg = '–ë–∞–π—Ä—à–ª—ã–Ω –º—ç–¥—ç—ç–ª—ç–ª –±–æ–ª–æ–º–∂–≥“Ø–π –±–∞–π–Ω–∞.';
                }

                showStatus('‚ùå ' + msg, 'error');
                studentInput.disabled = false;
                btn.disabled = false;
                if (actionButtons) actionButtons.classList.remove('hidden');
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            }
        );
    }

    btn.addEventListener('click', function(){
        const code = studentInput.value.trim();
        if(!code){
            showStatus('‚ö†Ô∏è –û—é—É—Ç–Ω—ã –∫–æ–¥ –æ—Ä—É—É–ª–Ω–∞ —É—É.', 'error');
            studentInput.focus();
            return;
        }
        submitAttendance(code);
    });

    studentInput.addEventListener('keydown', function(e){
        if(e.key === 'Enter' || e.keyCode === 13){
            e.preventDefault();
            btn.click();
        }
    });

    studentInput.addEventListener('focus', function(){
        status.className = 'status-message';
        status.style.display = 'none';
        if (actionButtons) actionButtons.classList.add('hidden');
    });

    if (expiresAtStr) {
        (function() {
            const expiresAt = new Date(expiresAtStr);
            const timerEl = document.getElementById('timer');

            function updateTimer() {
                const now = new Date();
                const diff = expiresAt - now;

                if (diff <= 0) {
                    if (timerEl) timerEl.textContent = '‚è±Ô∏è Session –¥—É—É—Å—Å–∞–Ω';
                    studentInput.disabled = true;
                    btn.disabled = true;
                    showStatus('‚ùå Session-–∏–π —Ö—É–≥–∞—Ü–∞–∞ –¥—É—É—Å—Å–∞–Ω –±–∞–π–Ω–∞', 'error');
                    return;
                }

                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);

                if (timerEl) {
                    timerEl.textContent = '‚è±Ô∏è “Æ–ª–¥—Å—ç–Ω —Ö—É–≥–∞—Ü–∞–∞: ' + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                }

                setTimeout(updateTimer, 1000);
            }

            updateTimer();
        })();
    }

    console.log('QR scan page initialized successfully');
})();
</script>
{% endblock %}
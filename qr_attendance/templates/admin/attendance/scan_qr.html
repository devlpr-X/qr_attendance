{% extends "base.html" %}
{% block title %}QR –£–Ω—à—É—É–ª–∞—Ö - {{ session.course_name }}{% endblock %}

{% block content %}
<style>
    .attendance-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .header-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header-info h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
    }

    .header-info p {
        margin: 0.3rem 0;
        opacity: 0.95;
    }

    .input-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .input-section label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #333;
    }

    .input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    #student_code {
        flex: 1;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    #student_code:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
        padding: 0.8rem 1.5rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        transition: background 0.3s;
    }

    button:hover {
        background: #5568d3;
    }

    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .location-info {
        background: #f0f4f8;
        padding: 1rem;
        border-left: 4px solid #4facfe;
        border-radius: 4px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }

    .location-info strong {
        color: #333;
    }

    .status-message {
        padding: 1rem;
        border-radius: 6px;
        margin-top: 1rem;
        text-align: center;
        font-weight: 600;
        display: none;
    }

    .status-message.loading {
        display: block;
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #90caf9;
    }

    .status-message.error {
        display: block;
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef5350;
    }

    .status-message.success {
        display: block;
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #66bb6a;
    }

    .info-box {
        background: #fff9c4;
        padding: 1rem;
        border-left: 4px solid #fbc02d;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .info-box strong {
        color: #f57f17;
    }

    .buttons-group {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .btn-secondary {
        background: #6c757d;
        flex: 1;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    .hidden {
        display: none !important;
    }

    .timer {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.5rem;
    }
</style>

<div class="attendance-container">
    <!-- –•–∏—á—ç—ç–ª–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª -->
    <div class="header-info">
        <h2>{{ session.course_name }}</h2>
        <p><strong>–ö–æ–¥:</strong> {{ session.course_code }}</p>
        <p><strong>–û–≥–Ω–æ–æ:</strong> {{ session.date }}</p>
        <p><strong>–¶–∞–≥:</strong> {{ session.timeslot }}</p>
        <p><strong>–¢”©—Ä”©–ª:</strong> {{ session.lesson_type }}</p>
    </div>

    <!-- –ë–∞–π—Ä—à–∏–ª—ã–Ω –º—ç–¥—ç—ç–ª—ç–ª -->
    {% if location %}
        <div class="location-info">
            üìç <strong>–ë–∞–π—Ä—à–∏–ª:</strong> {{ location.name }} (–†–∞–¥–∏—É—Å: {{ location.radius_m }} –º)<br>
            <small>–¢–∞ —ç–Ω—ç –±–∞–π—Ä—à–∏–ª–¥ –±–∞–π—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π</small>
        </div>
    {% else %}
        <div class="info-box">
            ‚ÑπÔ∏è <strong>–ê–Ω—Ö–∞–∞—Ä–Ω–∞ —É—É:</strong> –≠–Ω—ç —Å–µ—Å—Å-–¥ –±–∞–π—Ä—à–ª—ã–Ω —Ö—è–∑–≥–∞–∞—Ä–ª–∞–ª—Ç –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.
        </div>
    {% endif %}

    <!-- –û—é—É—Ç–Ω—ã –∫–æ–¥ –æ—Ä—É—É–ª–∞—Ö -->
    <div class="input-section">
        <label for="student_code">–û—é—É—Ç–Ω—ã –∫–æ–¥:</label>
        <div class="input-group">
            <input 
                type="text" 
                id="student_code" 
                placeholder="–û—é—É—Ç–Ω—ã –∫–æ–¥—ã–≥ –æ—Ä—É—É–ª–Ω–∞" 
                autocomplete="off"
                autofocus
            />
            <button type="button" id="btnSubmit">–ò–ª–≥—ç—ç—Ö</button>
        </div>
        <div class="timer" id="timer"></div>
        <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
            Enter —Ç–æ–≤—á –¥–∞—Ä–∂ —ç—Å–≤—ç–ª —Ç–æ–≤—á–ª—É—É—Ä—ã–≥ –¥–∞—Ä–Ω–∞
        </p>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å –º–µ—Å—Å–µ–∂ -->
    <div id="status" class="status-message"></div>

    <!-- –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ—Ö —Ç–æ–≤—á (–∞–ª–¥–∞–∞ “Ø–µ–¥) -->
    <div class="buttons-group hidden" id="actionButtons">
        <button type="button" class="btn-secondary" onclick="location.reload()">üîÑ –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ—Ö</button>
    </div>
</div>

<script>
(function(){
    const token = "{{ session.token }}";
    const studentInput = document.getElementById('student_code');
    const btn = document.getElementById('btnSubmit');
    const status = document.getElementById('status');
    const actionButtons = document.getElementById('actionButtons');
    const timerEl = document.getElementById('timer');
    let submitTimeout = null;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    // Device ID: localStorage –∞—à–∏–≥–ª–∞–Ω —Ç”©—Ö”©”©—Ä”©–º–∂ —Ç–∞–Ω—å–∏—Ö
    function getDeviceId(){
        let id = localStorage.getItem('device_id_attendance');
        if(!id){
            id = 'dev-' + Math.random().toString(36).slice(2,11) + '-' + Date.now().toString(36);
            localStorage.setItem('device_id_attendance', id);
        }
        return id;
    }

    // CSRF token –∞–≤–∞—Ö
    function getCookie(name) {
        const v = document.cookie.match("(^|;)\\s*" + name + "\\s*=\\s*([^;]+)");
        return v ? v.pop() : '';
    }

    // –°—Ç–∞—Ç—É—Å —Ö–∞—Ä—É—É–ª–∞—Ö
    function showStatus(message, type) {
        status.textContent = message;
        status.className = `status-message ${type}`;
    }

    // –ò—Ä—Ü –±“Ø—Ä—Ç–≥—ç—Ö —Ñ—É–Ω–∫—Ü
    function submitAttendance(student_code){
        if(submitTimeout) clearTimeout(submitTimeout);
        showStatus('üìç –ë–∞–π—Ä—à–∏–ª –∞–≤—á –±–∞–π–Ω–∞...', 'loading');
        studentInput.disabled = true;
        btn.disabled = true;
        
        if(!navigator.geolocation){
            showStatus('‚ùå –ë—Ä–∞—É–∑–µ—Ä –±–∞–π—Ä—à–∏–ª –¥—ç–º–∂–∏—Ö–≥“Ø–π –±–∞–π–Ω–∞', 'error');
            studentInput.disabled = false;
            btn.disabled = false;
            actionButtons.classList.remove('hidden');
            return;
        }

        navigator.geolocation.getCurrentPosition(function(pos){
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const device_id = getDeviceId();
            const device_info = navigator.userAgent || '';

            showStatus('üîÑ –ò–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞...', 'loading');

            // Form data –±“Ø—Ä–¥“Ø“Ø–ª—ç—Ö
            const fd = new FormData();
            fd.append('student_code', student_code);
            fd.append('lat', lat);
            fd.append('lon', lon);
            fd.append('device_id', device_id);
            fd.append('device_info', device_info);

            fetch(`/attendance/${token}/submit/`, {
                method: 'POST',
                body: fd,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            }).then(r => {
                if(!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.text();
            }).then(html => {
                // –°–µ—Ä–≤–µ—Ä “Ø—Ä –¥“Ø–Ω–≥—ç—ç—Ä —Ö–∞–∞—Ö
                document.open();
                document.write(html);
                document.close();
            }).catch(e => {
                retryCount++;
                if(retryCount < MAX_RETRIES){
                    showStatus(`‚ö†Ô∏è –ê–ª–¥–∞–∞: ${e.message}. ${MAX_RETRIES - retryCount} —É–¥–∞–∞ –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ—Ö –±–æ–ª–æ–º–∂—Ç–æ–π...`, 'error');
                    studentInput.disabled = false;
                    btn.disabled = false;
                    studentInput.focus();
                } else {
                    showStatus('‚ùå –°–µ—Ä–≤–µ—Ä—ç—ç—Å —Ö–∞—Ä–∏—É –∞–≤–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π –±–∞–π–Ω–∞. –ê–¥–º–∏–Ω-—Ç–∞–π —Ö–æ–ª–±–æ–≥–¥–æ–Ω–æ —É—É.', 'error');
                    actionButtons.classList.remove('hidden');
                    studentInput.disabled = false;
                    btn.disabled = false;
                }
            });

        }, function(err){
            let msg = '–ë–∞–π—Ä—à–∏–ª –∞–≤–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π';
            if(err.code === err.PERMISSION_DENIED){
                msg = '–ë–∞–π—Ä—à–ª—ã–≥ –∑”©–≤—à”©”©—Ä”©”©–≥“Ø–π –±–∞–π–Ω–∞. –ë—Ä–∞—É–∑–µ—Ä –¥—ç—ç—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–Ω–∞ —É—É.';
            } else if(err.code === err.TIMEOUT){
                msg = '–ë–∞–π—Ä—à–∏–ª –∞–≤–∞—Ö “Ø–µ–¥ —Ö—É–≥–∞—Ü–∞–∞ —Ö—ç—Ç—ç—Ä–ª—ç—ç.';
            }
            showStatus(`‚ùå ${msg}`, 'error');
            studentInput.disabled = false;
            btn.disabled = false;
            actionButtons.classList.remove('hidden');
        }, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        });
    }

    // –¢–æ–≤—á –¥–∞—Ä–∞—Ö
    btn.addEventListener('click', function(){
        const code = studentInput.value.trim();
        if(!code){
            showStatus('‚ö†Ô∏è –û—é—É—Ç–Ω—ã –∫–æ–¥ –æ—Ä—É—É–ª–Ω–∞ —É—É.', 'error');
            studentInput.focus();
            return;
        }
        submitAttendance(code);
    });

    // Enter —Ç–æ–≤—á –¥–∞—Ä–∞—Ö
    studentInput.addEventListener('keypress', function(e){
        if(e.key === 'Enter'){
            btn.click();
        }
    });

    // Input –¥—ç—ç—Ä focus “Ø–µ–¥ —Å—Ç–∞—Ç—É—Å —Ü—ç–≤—ç—Ä–ª—ç—Ö
    studentInput.addEventListener('focus', function(){
        status.className = 'status-message';
        actionButtons.classList.add('hidden');
        retryCount = 0;
    });

})();
</script>

{% endblock %}
{% extends "base.html" %}
{% load static %}
{% block title %}–•”©—Ç”©–ª–±”©—Ä{% endblock %}
{% block content %}

<link rel="stylesheet" href="/static/css/table_data.css">

<div style="max-width:1200px; margin:1.5rem auto;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
    <div style="display:flex; align-items:center; gap:0.75rem;">
      <!-- –ë—É—Ü–∞—Ö —Ç–æ–≤—á -->
      <a href="/admin/look-up/" class="btn-secondary" style="text-decoration: none;">
        ‚Üê
      </a>
      <h2 style="margin:0; color:#0b2e78;">–•”©—Ç”©–ª–±”©—Ä</h2>
    </div>
    <button id="btnAdd" class="btn-primary">–ù—ç–º—ç—Ö</button>
  </div>

  {% if error %}<div class="alert-error">{{ error }}</div>{% endif %}

  <div style="display:flex; gap:0.8rem; margin-bottom:1rem;">
    <input id="searchInput" placeholder="–•–∞–π–ª—Ç..." style="padding:0.6rem; border-radius:6px; border:1px solid #e5e7eb;">
    <div style="color:#6b7280;">–ù–∏–π—Ç: <strong id="totalCount">0</strong> | “Æ–∑“Ø“Ø–ª–∂ –±–∞–π–≥–∞–∞: <strong id="showingCount">0</strong></div>
  </div>

  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th data-sort="id" style="width:80px;">‚Ññ <span class="sort-icon">‚áÖ</span></th>
          <th data-sort="name">–ù—ç—Ä <span class="sort-icon">‚áÖ</span></th>
          <th data-sort="code">–ö–æ–¥ <span class="sort-icon">‚áÖ</span></th>
          <th data-sort="department_name">–¢—ç–Ω—Ö–∏–º <span class="sort-icon">‚áÖ</span></th>
          <th style="width:100px; text-align:center;">“Æ–π–ª–¥—ç–ª</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="5" style="text-align:center; padding:2rem;">–ê—á–∞–∞–ª–ª–∞–∂ –±–∞–π–Ω–∞...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<!-- ADD Modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–®–∏–Ω—ç –•”©—Ç”©–ª–±”©—Ä</h3>
      <button class="modal-close" onclick="closeAddModal()">‚úï</button>
    </div>

    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" value="add">

      <div class="form-group">
        <label>–ù—ç—Ä</label>
        <input name="name" required>
      </div>

      <div class="form-group">
        <label>–ö–æ–¥</label>
        <input name="code">
      </div>

      <div class="form-group">
        <label>–¢—ç–Ω—Ö–∏–º</label>
        <select name="department_id">
          <option value="">-- –°–æ–Ω–≥–æ—Ö --</option>
          {% for d in departments %}
            <option value="{{ d.0 }}">{{ d.1 }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeAddModal()">–ë–æ–ª–∏—Ö</button>
        <button class="btn-primary">–•–∞–¥–≥–∞–ª–∞—Ö</button>
      </div>
    </form>
  </div>
</div>

<!-- EDIT Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–•”©—Ç”©–ª–±”©—Ä –∑–∞—Å–≤–∞—Ä–ª–∞—Ö</h3>
      <button class="modal-close" onclick="closeEditModal()">‚úï</button>
    </div>

    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" value="edit">
      <input type="hidden" id="edit-id" name="id">

      <div class="form-group">
        <label>–ù—ç—Ä</label>
        <input id="edit-name" name="name" required>
      </div>

      <div class="form-group">
        <label>–ö–æ–¥</label>
        <input id="edit-code" name="code">
      </div>

      <div class="form-group">
        <label>–¢—ç–Ω—Ö–∏–º</label>
        <select id="edit-dept" name="department_id">
          <option value="">-- –°–æ–Ω–≥–æ—Ö --</option>
          {% for d in departments %}
            <option value="{{ d.0 }}">{{ d.1 }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeEditModal()">–ë–æ–ª–∏—Ö</button>
        <button class="btn-primary">–•–∞–¥–≥–∞–ª–∞—Ö</button>
      </div>
    </form>
  </div>
</div>

<!-- Action Menu -->
<div id="actionMenu" class="action-menu">
  <button class="action-item" onclick="editItem()">‚úèÔ∏è –ó–∞—Å–∞—Ö</button>
  <button class="action-item action-delete" onclick="deleteItem()">üóëÔ∏è –£—Å—Ç–≥–∞—Ö</button>
</div>

<script>
const djangoData = '{{ items|escapejs }}';
let allData = JSON.parse(djangoData || "[]");
let filteredData = [...allData];
let sortColumn = "id";
let sortDirection = "desc";
let currentActionId = null;
const itemsPerPage = 12;

document.addEventListener("DOMContentLoaded", ()=> { renderTable(); setupEvents(); });

function setupEvents(){
  document.getElementById("searchInput").oninput = (e) => {
    const q = e.target.value.toLowerCase();
    filteredData = allData.filter(x =>
      (x.name||'').toLowerCase().includes(q) ||
      (x.code||'').toLowerCase().includes(q) ||
      (x.department_name||'').toLowerCase().includes(q)
    );
    renderTable();
  };
  document.querySelectorAll("th[data-sort]").forEach(th=>{
    th.onclick = ()=>{ const col = th.dataset.sort; if(sortColumn===col) sortDirection = sortDirection === "asc" ? "desc" : "asc"; else { sortColumn = col; sortDirection = "asc"; } sortData(); renderTable(); }
  });
  document.getElementById("btnAdd").onclick = ()=> document.getElementById("addModal").style.display = "flex";
}

function sortData(){
  filteredData.sort((a,b)=>{
    const A = String(a[sortColumn]||'').toLowerCase(); const B = String(b[sortColumn]||'').toLowerCase();
    return sortDirection === "asc" ? A.localeCompare(B) : B.localeCompare(A);
  });
}

function renderTable(){
  const tbody=document.getElementById("tableBody");
  document.getElementById("totalCount").textContent = allData.length;
  document.getElementById("showingCount").textContent = filteredData.length;
  const pageData = filteredData.slice(0, itemsPerPage);
  if(!pageData.length){ tbody.innerHTML = `<tr><td colspan="5" style="padding:1.4rem; text-align:center;">”®–≥”©–≥–¥”©–ª –∞–ª–≥–∞</td></tr>`; return; }
  tbody.innerHTML = pageData.map((x,i)=>`<tr>
    <td>${i+1}</td>
    <td>${escapeHtml(x.name)}</td>
    <td><code>${escapeHtml(x.code||'')}</code></td>
    <td>${escapeHtml(x.department_name||'')}</td>
    <td style="text-align:center;"><button class="action-dots" onclick="openMenu(event, ${x.id})">‚ãÆ</button></td>
  </tr>`).join('');
}

/* action menu, edit/delete same as department template */
const actionMenu = document.getElementById("actionMenu");
let menuHover=false;
function openMenu(e,id){ currentActionId=id; e.stopPropagation(); actionMenu.style.display='block'; const rect = e.target.getBoundingClientRect(); const menuW = actionMenu.offsetWidth || 220; const left = Math.min(Math.max(rect.left - 120, 8), window.innerWidth - menuW - 8); const top = Math.min(rect.bottom + 5, window.innerHeight - actionMenu.offsetHeight - 8); actionMenu.style.left = `${left}px`; actionMenu.style.top = `${top}px`; }
actionMenu.addEventListener("mouseenter", ()=> menuHover=true);
actionMenu.addEventListener("mouseleave", ()=> { menuHover=false; setTimeout(()=> { if(!menuHover) actionMenu.style.display='none'; }, 80); });
document.addEventListener("click", (e)=> { if (!e.target.closest(".action-menu") && !e.target.closest(".action-dots")) actionMenu.style.display='none'; });

function editItem(){ const item = allData.find(x=>x.id===currentActionId); if(!item) return; document.getElementById("edit-id").value = item.id; document.getElementById("edit-name").value = item.name; document.getElementById("edit-code").value = item.code||''; document.getElementById("edit-dept").value = item.department_id||''; document.getElementById("editModal").style.display='flex'; actionMenu.style.display='none'; }
function deleteItem(){ if(!confirm('–£—Å—Ç–≥–∞—Ö —É—É?')) return; const form=document.createElement('form'); form.method='POST'; form.innerHTML = `
    {% csrf_token %}
    <input type="hidden" name="action" value="delete">
    <input type="hidden" name="id" value="${currentActionId}">
  `; document.body.appendChild(form); form.submit(); }
function closeAddModal(){ document.getElementById("addModal").style.display='none'; }
function closeEditModal(){ document.getElementById("editModal").style.display='none'; }
function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
</script>

{% endblock %}

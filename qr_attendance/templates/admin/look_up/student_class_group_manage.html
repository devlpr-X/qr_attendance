{% extends "base.html" %}
{% load static %}
{% block title %}–ê–Ω–≥–∏–¥ —ç–ª—Å—Å—ç–Ω –æ—é—É—Ç–Ω—É—É–¥{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/table_data.css' %}">
<div style="max-width:1600px; margin:0 auto; padding:20px;">
  
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
    <h2 style="margin:0; color:#0b2e78;">
      <a href="/admin/look-up/" class="btn-secondary" style="text-decoration:none;">‚Üê</a>&nbsp;
      –ê–Ω–≥–∏–¥ —ç–ª—Å—Å—ç–Ω –æ—é—É—Ç–Ω—É—É–¥
    </h2>
  </div>

  {% if error %}
    <div class="alert-error">{{ error }}</div>
  {% endif %}

  <!-- –ë“Æ–õ–≠–ì–¢ –≠–õ–°–°–≠–ù –û–Æ–£–¢–ù–£–£–î–´–ì –•–ê–†–ê–• –•–≠–°–≠–ì -->
  <div style="background:white; padding:1.2rem; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:1.5rem;">
    <h3 style="margin:0 0 1rem 0; color:#0b2e78;">üîç –ë“Ø–ª—ç–≥—Ç —ç–ª—Å—Å—ç–Ω –æ—é—É—Ç–Ω—É—É–¥—ã–≥ —Ö–∞—Ä–∞—Ö</h3>
    
    <form method="GET" id="filterForm">
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1rem;">
        
        <div class="form-group">
          <label>–°—É—Ä–≥—É—É–ª—å</label>
          <select name="school_id" id="filterSchool" style="width:100%;">
            <option value="">–ë“Ø–≥–¥</option>
            {% for s in schools %}
              <option value="{{ s.id }}" {% if filter_school == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>–û–Ω</label>
          <select name="year" id="filterYear" style="width:100%;">
            <option value="">–ë“Ø–≥–¥</option>
          </select>
        </div>

        <div class="form-group">
          <label>–¢—ç–Ω—Ö–∏–º</label>
          <select name="department_id" id="filterDepartment" style="width:100%;">
            <option value="">–ë“Ø–≥–¥</option>
          </select>
        </div>

        <div class="form-group">
          <label>–•”©—Ç”©–ª–±”©—Ä</label>
          <select name="program_id" id="filterProgram" style="width:100%;">
            <option value="">–ë“Ø–≥–¥</option>
          </select>
        </div>

        <div class="form-group">
          <label>–ê–Ω–≥–∏ –±“Ø–ª—ç–≥</label>
          <select name="class_group_id" id="filterClassGroup" style="width:100%;">
            <option value="">–ë“Ø–≥–¥</option>
          </select>
        </div>

        <div class="form-group">
          <label>–•–∞–π–ª—Ç</label>
          <input type="text" name="search" value="{{ search }}" placeholder="–ö–æ–¥, –Ω—ç—Ä..." style="width:100%;">
        </div>

        <div class="form-group">
          <label>–•—É—É–¥—Å–∞–Ω–¥</label>
          <select name="per_page" style="width:100%;">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:0.7rem; align-items:center;">
        <button type="submit" class="btn-primary">–®“Ø“Ø—Ö</button>
        <a href="?" class="btn-secondary" style="text-decoration:none;">–¶—ç–≤—ç—Ä–ª—ç—Ö</a>
        
        <div style="margin-left:auto; display:flex; gap:0.7rem; align-items:center;">
          <span style="color:#6b7280;">–ù–∏–π—Ç: <strong>{{ paginator.count }}</strong></span>
          
          {% if filter_school or filter_year or filter_department or filter_program or filter_class_group %}
          <button type="button" id="btnRemoveFiltered" class="btn-secondary"
                  style="background:#fee; color:#dc2626; border-color:#fca5a5;">
            ‚úï –®“Ø“Ø—Å—ç–Ω –±“Ø–≥–¥–∏–π–≥ –±“Ø–ª–≥—ç—ç—Å –≥–∞—Ä–≥–∞—Ö
          </button>
          {% endif %}
        </div>
      </div>
    </form>
  </div>

  <!-- –ñ–ê–ì–°–ê–ê–õ–¢ -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th style="width:60px;">‚Ññ</th>
          <th>–ö–æ–¥</th>
          <th>–û—é—É—Ç–∞–Ω</th>
          <th>–ê–Ω–≥–∏</th>
          <th>–û–Ω</th>
          <th>–•”©—Ç”©–ª–±”©—Ä</th>
          <th>–¢—ç–Ω—Ö–∏–º</th>
          <th>–°—É—Ä–≥—É—É–ª—å</th>
          <th style="width:150px;">–û–≥–Ω–æ–æ</th>
          <th style="width:100px; text-align:center;">“Æ–π–ª–¥—ç–ª</th>
        </tr>
      </thead>
      <tbody>
        {% for a in assignments %}
        <tr>
          <td>{{ forloop.counter|add:page_obj.start_index|add:"-1" }}</td>
          <td><strong>{{ a.student_code }}</strong></td>
          <td>{{ a.student_name }}</td>
          <td><span class="badge">{{ a.class_group_name }}</span></td>
          <td>{{ a.year|default:"-" }}</td>
          <td>{{ a.program_name }}</td>
          <td>{{ a.department_name }}</td>
          <td>{{ a.school_name }}</td>
          <td style="font-size:0.85rem; color:#6b7280;">{{ a.created_at }}</td>
          <td style="text-align:center;">
            <button class="action-dots" onclick="openMenu(event, '{{ a.id }}')">‚ãÆ</button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="10" style="padding:2rem; text-align:center; color:#9ca3af;">–û—é—É—Ç–∞–Ω –æ–ª–¥—Å–æ–Ω–≥“Ø–π</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  {% if paginator.num_pages > 1 %}
  <div class="pagination" style="margin-top:1.5rem;">
    {% if page_obj.has_previous %}
      <a href="?page=1&{{ request.GET.urlencode }}" class="pg-btn">¬´</a>
      <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" class="pg-btn">‚Äπ</a>
    {% endif %}
    <span style="padding:0.5rem 1rem; background:#1d5ede; color:white; border-radius:6px;">
      {{ page_obj.number }} / {{ paginator.num_pages }}
    </span>
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" class="pg-btn">‚Ä∫</a>
      <a href="?page={{ paginator.num_pages }}&{{ request.GET.urlencode }}" class="pg-btn">¬ª</a>
    {% endif %}
  </div>
  {% endif %}

  <!-- –û–Æ–£–¢–ê–ù –≠–õ–°“Æ“Æ–õ–≠–• –•–≠–°–≠–ì -->
  <div style="margin-top:3rem;">
    <h2 style="color:#0b2e78; margin-bottom:1rem;">‚ûï –û—é—É—Ç–Ω—É—É–¥—ã–≥ –∞–Ω–≥–∏–¥ —ç–ª—Å“Ø“Ø–ª—ç—Ö</h2>
    
    <div style="background:#fff3cd; padding:1rem; border-radius:8px; margin-bottom:1rem; border-left:4px solid #ffc107;">
      <strong>‚ö†Ô∏è –ê–Ω—Ö–∞–∞—Ä:</strong> –ù—ç–≥ –æ—é—É—Ç–∞–Ω —Ç—É—Ö–∞–π–Ω –æ–Ω–¥ –∑”©–≤—Ö”©–Ω –Ω—ç–≥ –±“Ø–ª—ç–≥—Ç —ç–ª—Å—ç—Ö –±–æ–ª–æ–º–∂—Ç–æ–π. 
      –•—ç—Ä—ç–≤ —Ç—É—Ö–∞–π–Ω –æ–Ω–¥ ”©”©—Ä –±“Ø–ª—ç–≥—Ç –∞–ª—å —Ö—ç–¥–∏–π–Ω —ç–ª—Å—Å—ç–Ω –±–æ–ª —ç–ª—Å“Ø“Ø–ª—ç—Ö –±–æ–ª–æ–º–∂–≥“Ø–π –±–æ–ª–Ω–æ.
    </div>

    <div style="background:white; padding:1.5rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.07);">
      
      <form method="POST" id="assignForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="assign">

        <!-- –®“Æ“Æ–õ–¢ -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
          
          <div class="form-group">
            <label>–°—É—Ä–≥—É—É–ª—å</label>
            <select id="assignSchool" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
              {% for s in schools %}
                <option value="{{ s.id }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>–û–Ω <span style="color:#dc2626;">*</span></label>
            <select id="assignYear" style="width:100%;" required>
              <option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>
            </select>
          </div>

          <div class="form-group">
            <label>–¢—ç–Ω—Ö–∏–º</label>
            <select id="assignDepartment" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
            </select>
          </div>

          <div class="form-group">
            <label>–•”©—Ç”©–ª–±”©—Ä</label>
            <select id="assignProgram" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
            </select>
          </div>

          <div class="form-group">
            <label>–ê–Ω–≥–∏ –±“Ø–ª—ç–≥ <span style="color:#dc2626;">*</span></label>
            <select id="assignClassGroup" name="class_group_id" required style="width:100%;">
              <option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>
            </select>
          </div>
        </div>

        <!-- –û–Æ–£–¢–ê–ù –•–ê–ô–õ–¢ -->
        <div style="margin-bottom:1rem;">
          <label style="font-weight:600;">–û—é—É—Ç–∞–Ω —Ö–∞–π—Ö</label>
          <input id="studentFilter" type="text" placeholder="–ö–æ–¥ —ç—Å–≤—ç–ª –Ω—ç—Ä..."
                 style="width:100%; padding:0.7rem; border-radius:8px; border:1px solid #e5e7eb;">
        </div>

        <!-- –¢–û–í–ß–õ–£–£–† -->
        <div style="display:flex; gap:1rem; margin-bottom:1rem; align-items:center; flex-wrap:wrap;">
          <button type="button" id="selectAllBtn" class="btn-secondary">
            ‚úì –ë“Ø–≥–¥–∏–π–≥ —Å–æ–Ω–≥–æ—Ö
          </button>
          <button type="button" id="deselectAllBtn" class="btn-secondary">
            ‚úó –ë“Ø–≥–¥–∏–π–≥ —Ü—É—Ü–ª–∞—Ö
          </button>
          
          <div style="color:#6b7280; font-size:0.95rem;">
            <strong id="visibleCount">0</strong> —Ö–∞—Ä–∞–≥–¥–∞–∂ –±–∞–π–Ω–∞ ‚Ä¢
            <strong id="selectedCount">0</strong> —Å–æ–Ω–≥–æ–≥–¥–ª–æ–æ ‚Ä¢
            <strong id="blockedCount">0</strong> ”©”©—Ä –±“Ø–ª—ç–≥—Ç —ç–ª—Å—Å—ç–Ω
          </div>

          <button type="submit" class="btn-primary" style="margin-left:auto;">
            ‚ûú –°–æ–Ω–≥–æ—Å–æ–Ω –æ—é—É—Ç–Ω—É—É–¥—ã–≥ —ç–ª—Å“Ø“Ø–ª—ç—Ö
          </button>
        </div>

        <!-- –û–Æ–£–¢–ù–´ –ñ–ê–ì–°–ê–ê–õ–¢ -->
        <div style="max-height:400px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; background:#fafafa;">
          <table style="width:100%;">
            <tbody id="studentTableBody">
              <tr><td style="padding:2rem; text-align:center; color:#9ca3af;">–û–Ω –±–æ–ª–æ–Ω –∞–Ω–≥–∏ –±“Ø–ª—ç–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É...</td></tr>
            </tbody>
          </table>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Action Menu -->
<div id="actionMenu" class="action-menu">
  <button class="action-item action-delete" onclick="removeStudent()">‚úï –ë“Ø–ª–≥—ç—ç—Å –≥–∞—Ä–≥–∞—Ö</button>
</div>

<!-- Remove form -->
<form id="removeForm" method="POST" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="action" value="remove">
  <input type="hidden" id="removeId" name="id">
</form>

<!-- Remove filtered form -->
<form id="removeFilteredForm" method="POST" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="action" value="remove_filtered">
  <input type="hidden" name="filter_school" value="{{ filter_school }}">
  <input type="hidden" name="filter_year" value="{{ filter_year }}">
  <input type="hidden" name="filter_department" value="{{ filter_department }}">
  <input type="hidden" name="filter_program" value="{{ filter_program }}">
  <input type="hidden" name="filter_class_group" value="{{ filter_class_group }}">
</form>

<style>
.pg-btn {
  padding:0.5rem 0.9rem;
  background:white;
  border-radius:6px;
  text-decoration:none;
  color:#334155;
  border:1px solid #e2e8f0;
  display:inline-block;
}
.pg-btn:hover { background:#f1f5f9; }
.student-row:hover { background:#eef4ff; }
.student-row { cursor:pointer; transition:background 0.15s; }
.student-row.in-current-group { background:#fef3c7; opacity:0.7; }
.student-row.in-other-group { background:#fee; opacity:0.6; }
</style>

<script>
// ========== DATA ==========
const schoolsData = JSON.parse('{{ schools_json|escapejs }}');
const yearsData = JSON.parse('{{ years_json|escapejs }}');
const departmentsData = JSON.parse('{{ departments_json|escapejs }}');
const programsData = JSON.parse('{{ programs_json|escapejs }}');
const classGroupsData = JSON.parse('{{ class_groups_json|escapejs }}');
const studentsData = JSON.parse('{{ students_json|escapejs }}');
let assignedStudentIds = JSON.parse('{{ assigned_student_ids_json|escapejs }}');
let yearEnrollments = JSON.parse('{{ year_enrollments_json|escapejs }}');

let currentActionId = null;
let selectedYear = null;
let selectedClassGroupId = null;

// ========== FILTER SECTION (TOP) ==========
const filterSchool = document.getElementById('filterSchool');
const filterYear = document.getElementById('filterYear');
const filterDepartment = document.getElementById('filterDepartment');
const filterProgram = document.getElementById('filterProgram');
const filterClassGroup = document.getElementById('filterClassGroup');

function populateFilterYears(schoolId) {
  let years = [...new Set(classGroupsData
    .filter(g => !schoolId || String(g.school_id) === String(schoolId))
    .map(g => g.year)
    .filter(y => y != null))].sort((a,b) => b - a);
  
  filterYear.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    years.map(y => {
      const sel = '{{ filter_year }}' === String(y) ? 'selected' : '';
      return `<option value="${y}" ${sel}>${y}</option>`;
    }).join('');
}

function populateFilterDepartments(schoolId) {
  const depts = departmentsData.filter(d => !schoolId || String(d.school_id) === String(schoolId));
  filterDepartment.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    depts.map(d => {
      const sel = '{{ filter_department }}' === String(d.id) ? 'selected' : '';
      return `<option value="${d.id}" ${sel}>${escapeHtml(d.name)}</option>`;
    }).join('');
}

function populateFilterPrograms(schoolId, departmentId) {
  let progs = programsData;
  if (schoolId) progs = progs.filter(p => String(p.school_id) === String(schoolId));
  if (departmentId) progs = progs.filter(p => String(p.department_id) === String(departmentId));
  
  filterProgram.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    progs.map(p => {
      const sel = '{{ filter_program }}' === String(p.id) ? 'selected' : '';
      return `<option value="${p.id}" ${sel}>${escapeHtml(p.name)}</option>`;
    }).join('');
}

function populateFilterClassGroups(schoolId, year, departmentId, programId) {
  let groups = classGroupsData;
  if (schoolId) groups = groups.filter(g => String(g.school_id) === String(schoolId));
  if (year) groups = groups.filter(g => String(g.year) === String(year));
  if (departmentId) groups = groups.filter(g => String(g.department_id) === String(departmentId));
  if (programId) groups = groups.filter(g => String(g.program_id) === String(programId));
  
  filterClassGroup.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    groups.map(g => {
      const sel = '{{ filter_class_group }}' === String(g.id) ? 'selected' : '';
      return `<option value="${g.id}" ${sel}>${escapeHtml(g.name)}</option>`;
    }).join('');
}

filterSchool.addEventListener('change', () => {
  const sid = filterSchool.value || null;
  populateFilterYears(sid);
  populateFilterDepartments(sid);
  populateFilterPrograms(sid, null);
  populateFilterClassGroups(sid, null, null, null);
});

filterYear.addEventListener('change', () => {
  populateFilterClassGroups(filterSchool.value, filterYear.value, filterDepartment.value, filterProgram.value);
});

filterDepartment.addEventListener('change', () => {
  populateFilterPrograms(filterSchool.value, filterDepartment.value);
  populateFilterClassGroups(filterSchool.value, filterYear.value, filterDepartment.value, filterProgram.value);
});

filterProgram.addEventListener('change', () => {
  populateFilterClassGroups(filterSchool.value, filterYear.value, filterDepartment.value, filterProgram.value);
});

// Init
populateFilterYears('{{ filter_school }}');
populateFilterDepartments('{{ filter_school }}');
populateFilterPrograms('{{ filter_school }}', '{{ filter_department }}');
populateFilterClassGroups('{{ filter_school }}', '{{ filter_year }}', '{{ filter_department }}', '{{ filter_program }}');

// ========== ASSIGN SECTION (BOTTOM) ==========
const assignSchool = document.getElementById('assignSchool');
const assignYear = document.getElementById('assignYear');
const assignDepartment = document.getElementById('assignDepartment');
const assignProgram = document.getElementById('assignProgram');
const assignClassGroup = document.getElementById('assignClassGroup');
const studentTableBody = document.getElementById('studentTableBody');
const studentFilter = document.getElementById('studentFilter');
const visibleCount = document.getElementById('visibleCount');
const selectedCount = document.getElementById('selectedCount');
const blockedCount = document.getElementById('blockedCount');

let filteredStudents = [];

function populateAssignYears(schoolId) {
  let years = [...new Set(classGroupsData
    .filter(g => !schoolId || String(g.school_id) === String(schoolId))
    .map(g => g.year)
    .filter(y => y != null))].sort((a,b) => b - a);
  
  assignYear.innerHTML = '<option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>' +
    years.map(y => `<option value="${y}">${y}</option>`).join('');
}

function populateAssignDepartments(schoolId) {
  const depts = departmentsData.filter(d => !schoolId || String(d.school_id) === String(schoolId));
  assignDepartment.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    depts.map(d => `<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('');
}

function populateAssignPrograms(schoolId, departmentId) {
  let progs = programsData;
  if (schoolId) progs = progs.filter(p => String(p.school_id) === String(schoolId));
  if (departmentId) progs = progs.filter(p => String(p.department_id) === String(departmentId));
  
  assignProgram.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    progs.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
}

function populateAssignClassGroups(schoolId, year, departmentId, programId) {
  let groups = classGroupsData;
  if (schoolId) groups = groups.filter(g => String(g.school_id) === String(schoolId));
  if (year) groups = groups.filter(g => String(g.year) === String(year));
  if (departmentId) groups = groups.filter(g => String(g.department_id) === String(departmentId));
  if (programId) groups = groups.filter(g => String(g.program_id) === String(programId));
  
  assignClassGroup.innerHTML = '<option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>' +
    groups.map(g => `<option value="${g.id}">${escapeHtml(g.name)}</option>`).join('');
}

async function loadYearEnrollments(year) {
  if (!year) {
    yearEnrollments = {};
    return;
  }
  
  try {
    const response = await fetch(`?assign_year=${year}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const scripts = doc.querySelectorAll('script');
    
    for (let script of scripts) {
      const match = script.textContent.match(/yearEnrollments = JSON\.parse\('(.+?)'\)/);
      if (match) {
        const jsonStr = match[1].replace(/\\'/g, "'").replace(/\\\\/g, '\\');
        yearEnrollments = JSON.parse(jsonStr);
        break;
      }
    }
  } catch (e) {
    console.error('–û–Ω—ã —ç–ª—Å—ç–ª—Ç–∏–π–≥ —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞:', e);
    yearEnrollments = {};
  }
}

async function loadAssignedStudents(classGroupId) {
  if (!classGroupId) {
    assignedStudentIds = [];
    return;
  }
  
  try {
    const response = await fetch(`?assign_class_group_id=${classGroupId}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const scripts = doc.querySelectorAll('script');
    
    for (let script of scripts) {
      const match = script.textContent.match(/assignedStudentIds = JSON\.parse\('(.+?)'\)/);
      if (match) {
        const jsonStr = match[1].replace(/\\'/g, "'");
        assignedStudentIds = JSON.parse(jsonStr);
        break;
      }
    }
  } catch (e) {
    console.error('–≠–ª—Å—Å—ç–Ω –æ—é—É—Ç–Ω—É—É–¥—ã–≥ —Ç–∞—Ç–∞—Ö–∞–¥ –∞–ª–¥–∞–∞:', e);
    assignedStudentIds = [];
  }
}

function filterStudents() {
  const searchQ = (studentFilter.value || '').toLowerCase();
  
  filteredStudents = studentsData.filter(s => {
    const text = `${s.student_code} ${s.full_name}`.toLowerCase();
    return !searchQ || text.includes(searchQ);
  });
  
  renderStudents();
}

function renderStudents() {
  if (!selectedYear || !selectedClassGroupId) {
    studentTableBody.innerHTML = '<tr><td style="padding:2rem; text-align:center; color:#9ca3af;">–û–Ω –±–æ–ª–æ–Ω –∞–Ω–≥–∏ –±“Ø–ª—ç–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É...</td></tr>';
    updateCounters();
    return;
  }
  
  if (filteredStudents.length === 0) {
    studentTableBody.innerHTML = '<tr><td style="padding:2rem; text-align:center; color:#9ca3af;">–û—é—É—Ç–∞–Ω –æ–ª–¥—Å–æ–Ω–≥“Ø–π</td></tr>';
  } else {
    studentTableBody.innerHTML = filteredStudents.map(s => {
      const inCurrentGroup = assignedStudentIds.includes(s.id);
      const enrollment = yearEnrollments[s.id];
      const inOtherGroup = enrollment && String(enrollment.class_group_id) !== String(selectedClassGroupId);
      
      let rowClass = 'student-row';
      let disabled = '';
      let label = '';
      
      if (inCurrentGroup) {
        rowClass += ' in-current-group';
        disabled = 'disabled';
        label = `<strong>${escapeHtml(s.student_code)}</strong> - ${escapeHtml(s.full_name)} <span style="color:#f59e0b;">(—ç–Ω—ç –±“Ø–ª—ç–≥—Ç —ç–ª—Å—Å—ç–Ω)</span>`;
      } else if (inOtherGroup) {
        rowClass += ' in-other-group';
        disabled = 'disabled';
        label = `<strong>${escapeHtml(s.student_code)}</strong> - ${escapeHtml(s.full_name)} <span style="color:#dc2626;">(${selectedYear} –æ–Ω–¥ "${escapeHtml(enrollment.class_group_name)}" –±“Ø–ª—ç–≥—Ç —ç–ª—Å—Å—ç–Ω)</span>`;
      } else {
        label = `<strong>${escapeHtml(s.student_code)}</strong> - ${escapeHtml(s.full_name)}`;
      }
      
      return `
        <tr class="${rowClass}">
          <td style="padding:0.6rem;">
            <label style="cursor:pointer; display:flex; align-items:center;">
              <input class="student-checkbox" type="checkbox" name="student_ids" value="${s.id}" ${disabled}>
              <span style="margin-left:0.7rem;">${label}</span>
            </label>
          </td>
        </tr>
      `;
    }).join('');
    
    document.querySelectorAll('.student-checkbox').forEach(cb => {
      cb.addEventListener('change', updateCounters);
    });
  }
  
  updateCounters();
}

function updateCounters() {
  visibleCount.textContent = filteredStudents.length;
  selectedCount.textContent = document.querySelectorAll('.student-checkbox:checked').length;
  
  let blocked = 0;
  filteredStudents.forEach(s => {
    const inCurrentGroup = assignedStudentIds.includes(s.id);
    const enrollment = yearEnrollments[s.id];
    const inOtherGroup = enrollment && String(enrollment.class_group_id) !== String(selectedClassGroupId);
    if (inCurrentGroup || inOtherGroup) blocked++;
  });
  blockedCount.textContent = blocked;
}

assignSchool.addEventListener('change', () => {
  const sid = assignSchool.value || null;
  populateAssignYears(sid);
  populateAssignDepartments(sid);
  populateAssignPrograms(sid, null);
  populateAssignClassGroups(sid, null, null, null);
  selectedYear = null;
  selectedClassGroupId = null;
  yearEnrollments = {};
  assignedStudentIds = [];
  filterStudents();
});

assignYear.addEventListener('change', async () => {
  selectedYear = assignYear.value || null;
  populateAssignClassGroups(assignSchool.value, selectedYear, assignDepartment.value, assignProgram.value);
  
  if (selectedYear) {
    await loadYearEnrollments(selectedYear);
  } else {
    yearEnrollments = {};
  }
  
  filterStudents();
});

assignDepartment.addEventListener('change', () => {
  populateAssignPrograms(assignSchool.value, assignDepartment.value);
  populateAssignClassGroups(assignSchool.value, assignYear.value, assignDepartment.value, assignProgram.value);
});

assignProgram.addEventListener('change', () => {
  populateAssignClassGroups(assignSchool.value, assignYear.value, assignDepartment.value, assignProgram.value);
});

assignClassGroup.addEventListener('change', async () => {
  selectedClassGroupId = assignClassGroup.value || null;
  
  if (selectedClassGroupId) {
    await loadAssignedStudents(selectedClassGroupId);
  } else {
    assignedStudentIds = [];
  }
  
  filterStudents();
});

studentFilter.addEventListener('input', filterStudents);

document.getElementById('selectAllBtn').addEventListener('click', () => {
  document.querySelectorAll('.student-checkbox:not([disabled])').forEach(cb => cb.checked = true);
  updateCounters();
});
// --- –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ ---
document.getElementById('deselectAllBtn').addEventListener('click', () => {
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
  updateCounters();
});

// Submit handler: —à–∞–ª–≥–∞—Ö (–æ–Ω, –∞–Ω–≥–∏ —Å–æ–Ω–≥–æ–≥–¥—Å–æ–Ω —ç—Å—ç—Ö) –±–∞ —Å—É–ª checkbox-—É—É–¥—ã–≥ submit-–¥ –æ—Ä—É—É–ª–∞—Ö
const assignForm = document.getElementById('assignForm');
assignForm.addEventListener('submit', (e) => {
  // –ê–Ω—Ö–∞–∞—Ä: browser will send checked inputs with name="student_ids" automatically.
  // –ë–∏–¥ –∑”©–≤—Ö”©–Ω –≤–∞–ª–∏–¥–∞—Ü —Ö–∏–π–Ω—ç.
  if (!assignYear.value) {
    e.preventDefault();
    alert('–≠–ª—Å“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –û–Ω-–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É.');
    return;
  }
  if (!assignClassGroup.value) {
    e.preventDefault();
    alert('–≠–ª—Å“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –ê–Ω–≥–∏ –±“Ø–ª–≥–∏–π–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É.');
    return;
  }
  const anyChecked = !!document.querySelector('.student-checkbox:checked');
  if (!anyChecked) {
    e.preventDefault();
    alert('–≠–ª—Å“Ø“Ø–ª—ç—Ö –æ—é—É—Ç–Ω—É—É–¥—ã–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É.');
    return;
  }
  // OK ‚Äî submit —è–≤–Ω–∞ (csrf token form-–¥ –±–∞–π–≥–∞–∞)
});

// ========== ACTION MENU ==========
// –≠–Ω—ç —Ö—ç—Å—ç–≥ –Ω—å –Ω–∏–π–ª“Ø“Ø–ª—Å—ç–Ω –∂–∞–≥—Å–∞–∞–ª—Ç–∞–∞—Å 'remove' “Ø–π–ª–¥–ª–∏–π–≥ –≥“Ø–π—Ü—ç—Ç–≥—ç–Ω—ç
const actionMenu = document.getElementById('actionMenu');

function openMenu(e, id) {
  currentActionId = id;
  const rect = e.target.getBoundingClientRect();
  actionMenu.style.display = 'block';
  actionMenu.style.position = 'fixed';
  actionMenu.style.top = `${rect.bottom + 5}px`;
  actionMenu.style.left = `${rect.left - 120}px`;
}

function removeStudent() {
  if (!confirm('–û—é—É—Ç–Ω—ã–≥ –±“Ø–ª–≥—ç—ç—Å –≥–∞—Ä–≥–∞—Ö —É—É?')) return;
  document.getElementById('removeId').value = currentActionId;
  document.getElementById('removeForm').submit();
}

// Click outside menu -> —Ö–∞–∞—Ö
document.addEventListener('click', (e) => {
  if (!e.target.closest('.action-menu') && !e.target.closest('.action-dots')) {
    actionMenu.style.display = 'none';
  }
});

// Remove filtered (top) —Ç–æ–≤—á
const btnRemoveFiltered = document.getElementById('btnRemoveFiltered');
if (btnRemoveFiltered) {
  btnRemoveFiltered.addEventListener('click', () => {
    if (!confirm('–®“Ø“Ø–≥–¥—Å—ç–Ω –±“Ø—Ö –æ—é—É—Ç–Ω—É—É–¥—ã–≥ –±“Ø–ª–≥—ç—ç—Å –≥–∞—Ä–≥–∞—Ö —É—É? –≠–Ω—ç “Ø–π–ª–¥–ª–∏–π–≥ –±—É—Ü–∞–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π!')) return;
    document.getElementById('removeFilteredForm').submit();
  });
}

// Utility
function escapeHtml(t) {
  const div = document.createElement('div');
  div.textContent = t == null ? '' : t;
  return div.innerHTML;
}

// Page load ‚Äî —Ö—ç—Ä–≤—ç—ç —ç—Ö—ç–Ω–¥—ç—ç –∞–Ω–≥–∏ —Å–æ–Ω–≥–æ–≥–¥—Å–æ–Ω –±–∞–π–≤–∞–ª assignedStudentIds-–∏–π–≥ —Å–µ—Ä–≤–µ—Ä—ç—ç—Å —É–Ω—à–∏–∂ –∞–≤–∞—Ö
document.addEventListener('DOMContentLoaded', async () => {
  if (assignClassGroup && assignClassGroup.value) {
    // –¢—É—Ö–∞–π–Ω “Ø–µ–¥ –∞—à–∏–≥–ª–∞–∂ –±–∞–π–≥–∞–∞ loadAssignedStudents —Ñ—É–Ω–∫—Ü—ã–≥ –¥—É—É–¥–Ω–∞
    await loadAssignedStudents(assignClassGroup.value);
    // –•—ç—Ä–≤—ç—ç –æ–Ω —Å–æ–Ω–≥–æ–≥–¥—Å–æ–Ω –±–æ–ª –æ–Ω—ã —ç–ª—Å—ç–ª—Ç–∏–π–≥ —á —Ç–∞—Ç–Ω–∞
    if (assignYear && assignYear.value) {
      await loadYearEnrollments(assignYear.value);
    }
    filterStudents();
  }
});
</script>
{% endblock %}

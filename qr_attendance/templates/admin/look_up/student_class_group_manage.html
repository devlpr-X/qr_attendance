{% extends "base.html" %}
{% load static %}

{% block title %}–ê–Ω–≥–∏–¥ —ç–ª—Å—Å—ç–Ω –æ—é—É—Ç–Ω—É—É–¥{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/table_data.css' %}">

<div style="max-width:1600px; margin:0 auto; padding:20px;">
  
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
    <h2 style="margin:0; color:#0b2e78;">
      <a href="/admin/look-up/" class="btn-secondary" style="text-decoration:none;">‚Üê</a>&nbsp;
      –ê–Ω–≥–∏–¥ —ç–ª—Å—Å—ç–Ω –æ—é—É—Ç–Ω—É—É–¥
    </h2>
  </div>

  {% if error %}
    <div class="alert-error">{{ error }}</div>
  {% endif %}

  <!-- –®“Æ“Æ–õ–¢ –•–≠–°–≠–ì -->
  <div style="background:white; padding:1.2rem; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); margin-bottom:1.5rem;">
    <form method="GET" id="filterForm">
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:1rem; margin-bottom:1rem;">
        
        <div class="form-group">
          <label>–°—É—Ä–≥—É—É–ª—å</label>
          <select name="school_id" id="filterSchool" style="width:100%;">
            <option value="">–ë“Ø–≥–¥</option>
            {% for s in schools %}
              <option value="{{ s.id }}" {% if filter_school == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>–°–µ–º–µ—Å—Ç–µ—Ä</label>
          <select name="semester_id" id="filterSemester" style="width:100%;">
            <option value="">–ë“Ø–≥–¥</option>
          </select>
        </div>

        <div class="form-group">
          <label>–¢—ç–Ω—Ö–∏–º</label>
          <select name="department_id" id="filterDepartment" style="width:100%;">
            <option value="">–ë“Ø–≥–¥</option>
          </select>
        </div>

        <div class="form-group">
          <label>–ê–Ω–≥–∏ –±“Ø–ª—ç–≥</label>
          <select name="class_group_id" id="filterClassGroup" style="width:100%;">
            <option value="">–ë“Ø–≥–¥</option>
          </select>
        </div>

        <div class="form-group">
          <label>–•–∞–π–ª—Ç</label>
          <input type="text" name="search" value="{{ search }}" placeholder="–ö–æ–¥, –Ω—ç—Ä..." style="width:100%;">
        </div>

        <div class="form-group">
          <label>–•—É—É–¥—Å–∞–Ω–¥</label>
          <select name="per_page" style="width:100%;">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:0.7rem; align-items:center;">
        <button type="submit" class="btn-primary">–®“Ø“Ø—Ö</button>
        <a href="?" class="btn-secondary" style="text-decoration:none;">–¶—ç–≤—ç—Ä–ª—ç—Ö</a>
        
        <div style="margin-left:auto; display:flex; gap:0.7rem;">
          <span style="color:#6b7280;">–ù–∏–π—Ç: <strong>{{ paginator.count }}</strong></span>
          
          {% if filter_school or filter_semester or filter_department or filter_class_group %}
          <button type="button" id="btnDeleteFiltered" class="btn-secondary" 
                  style="background:#fee; color:#dc2626; border-color:#fca5a5;">
            üóëÔ∏è –®“Ø“Ø—Å—ç–Ω –±“Ø–≥–¥–∏–π–≥ —É—Å—Ç–≥–∞—Ö
          </button>
          {% endif %}
        </div>
      </div>
    </form>
  </div>

  <!-- –ñ–ê–ì–°–ê–ê–õ–¢ -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th style="width:60px;">‚Ññ</th>
          <th>–ö–æ–¥</th>
          <th>–û—é—É—Ç–∞–Ω</th>
          <th>–ê–Ω–≥–∏</th>
          <th>–¢—ç–Ω—Ö–∏–º</th>
          <th>–°–µ–º–µ—Å—Ç–µ—Ä</th>
          <th>–°—É—Ä–≥—É—É–ª—å</th>
          <th style="width:150px;">–û–≥–Ω–æ–æ</th>
          <th style="width:100px; text-align:center;">“Æ–π–ª–¥—ç–ª</th>
        </tr>
      </thead>
      <tbody>
        {% for a in assignments %}
        <tr>
          <td>{{ forloop.counter|add:page_obj.start_index|add:"-1" }}</td>
          <td><strong>{{ a.student_code }}</strong></td>
          <td>{{ a.student_name }}</td>
          <td><span class="badge">{{ a.class_group_name }}</span></td>
          <td>{{ a.department_name }}</td>
          <td>{{ a.semester_name|default:"-" }}</td>
          <td>{{ a.school_name }}</td>
          <td style="font-size:0.85rem; color:#6b7280;">{{ a.created_at }}</td>
          <td style="text-align:center;">
            <button class="action-dots" onclick="openMenu(event, '{{ a.id }}')">‚ãÆ</button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9" style="padding:2rem; text-align:center; color:#9ca3af;">–•–æ–ª–±–æ–ª—Ç –æ–ª–¥—Å–æ–Ω–≥“Ø–π</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  {% if paginator.num_pages > 1 %}
  <div class="pagination" style="margin-top:1.5rem;">
    {% if page_obj.has_previous %}
      <a href="?page=1&{{ request.GET.urlencode }}" class="pg-btn">¬´</a>
      <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" class="pg-btn">‚Äπ</a>
    {% endif %}

    <span style="padding:0.5rem 1rem; background:#1d5ede; color:white; border-radius:6px;">
      {{ page_obj.number }} / {{ paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" class="pg-btn">‚Ä∫</a>
      <a href="?page={{ paginator.num_pages }}&{{ request.GET.urlencode }}" class="pg-btn">¬ª</a>
    {% endif %}
  </div>
  {% endif %}

  <!-- –û–Æ–£–¢–ê–ù –ë“Æ–†–¢–ì–≠–• –•–≠–°–≠–ì -->
  <div style="margin-top:3rem;">
    <h2 style="color:#0b2e78; margin-bottom:1rem;">–û—é—É—Ç–Ω—É—É–¥—ã–≥ –∞–Ω–≥–∏–¥ –±“Ø—Ä—Ç–≥—ç—Ö</h2>

    <div style="background:white; padding:1.5rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.07);">
      
      <form method="POST" id="assignForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="assign">

        <!-- –®“Æ“Æ–õ–¢ -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
          
          <div class="form-group">
            <label>–°—É—Ä–≥—É—É–ª—å</label>
            <select id="assignSchool" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
              {% for s in schools %}
                <option value="{{ s.id }}">{{ s.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>–°–µ–º–µ—Å—Ç–µ—Ä</label>
            <select id="assignSemester" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
            </select>
          </div>

          <div class="form-group">
            <label>–¢—ç–Ω—Ö–∏–º</label>
            <select id="assignDepartment" style="width:100%;">
              <option value="">–ë“Ø–≥–¥</option>
            </select>
          </div>

          <div class="form-group">
            <label>–ê–Ω–≥–∏ –±“Ø–ª—ç–≥ <span style="color:#dc2626;">*</span></label>
            <select id="assignClassGroup" name="class_group_id" required style="width:100%;">
              <option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>
            </select>
          </div>
        </div>

        <!-- –û–Æ–£–¢–ê–ù –•–ê–ô–õ–¢ -->
        <div style="margin-bottom:1rem;">
          <label style="font-weight:600;">–û—é—É—Ç–∞–Ω —Ö–∞–π—Ö</label>
          <input id="studentFilter" type="text" placeholder="–ö–æ–¥ —ç—Å–≤—ç–ª –Ω—ç—Ä..." 
                 style="width:100%; padding:0.7rem; border-radius:8px; border:1px solid #e5e7eb;">
        </div>

        <!-- –¢–û–í–ß–õ–£–£–† -->
        <div style="display:flex; gap:1rem; margin-bottom:1rem; align-items:center; flex-wrap:wrap;">
          <button type="button" id="selectAllBtn" class="btn-secondary">
            ‚úì –ë“Ø–≥–¥–∏–π–≥ —Å–æ–Ω–≥–æ—Ö
          </button>
          <button type="button" id="deselectAllBtn" class="btn-secondary">
            ‚úó –ë“Ø–≥–¥–∏–π–≥ —Ü—É—Ü–ª–∞—Ö
          </button>
          
          <div style="color:#6b7280; font-size:0.95rem;">
            <strong id="visibleCount">0</strong> —Ö–∞—Ä–∞–≥–¥–∞–∂ –±–∞–π–Ω–∞ ‚Ä¢ 
            <strong id="selectedCount">0</strong> —Å–æ–Ω–≥–æ–≥–¥–ª–æ–æ
          </div>

          <button type="submit" class="btn-primary" style="margin-left:auto;">
            ‚ûú –°–æ–Ω–≥–æ—Å–æ–Ω –æ—é—É—Ç–Ω—É—É–¥—ã–≥ –±“Ø—Ä—Ç–≥—ç—Ö
          </button>
        </div>

        <!-- –û–Æ–£–¢–ù–´ –ñ–ê–ì–°–ê–ê–õ–¢ -->
        <div style="max-height:400px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; background:#fafafa;">
          <table style="width:100%;">
            <tbody id="studentTableBody">
              <tr><td style="padding:2rem; text-align:center; color:#9ca3af;">–û—é—É—Ç–∞–Ω —Å–æ–Ω–≥–æ–Ω–æ —É—É...</td></tr>
            </tbody>
          </table>
        </div>
      </form>

    </div>
  </div>

</div>

<!-- Action Menu -->
<div id="actionMenu" class="action-menu">
  <button class="action-item action-delete" onclick="deleteItem()">üóëÔ∏è –£—Å—Ç–≥–∞—Ö</button>
</div>

<!-- Hidden delete form -->
<form id="deleteForm" method="POST" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="action" value="delete">
  <input type="hidden" id="deleteId" name="id">
</form>

<!-- Delete filtered form -->
<form id="deleteFilteredForm" method="POST" style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="action" value="delete_filtered">
  <input type="hidden" name="filter_school" value="{{ filter_school }}">
  <input type="hidden" name="filter_semester" value="{{ filter_semester }}">
  <input type="hidden" name="filter_department" value="{{ filter_department }}">
  <input type="hidden" name="filter_class_group" value="{{ filter_class_group }}">
</form>

<style>
.pg-btn { 
  padding:0.5rem 0.9rem; 
  background:white; 
  border-radius:6px; 
  text-decoration:none; 
  color:#334155; 
  border:1px solid #e2e8f0; 
  display:inline-block;
}
.pg-btn:hover { background:#f1f5f9; }
.student-row:hover { background:#eef4ff; }
.student-row { cursor:pointer; transition:background 0.15s; }
</style>

<script>
const djangoSchools = '{{ schools_json|escapejs }}';
const djangoSemesters = '{{ semesters_json|escapejs }}';
const djangoDepartments = '{{ departments_json|escapejs }}';
const djangoClassGroups = '{{ class_groups_json|escapejs }}';
const djangoStudents = '{{ students_json|escapejs }}';
const djangoAssignedStudents = '{{ assigned_student_ids_json|escapejs }}';

const schoolsData = djangoSchools ? JSON.parse(djangoSchools) : [];
const semestersData = djangoSemesters ? JSON.parse(djangoSemesters) : [];
const departmentsData = djangoDepartments ? JSON.parse(djangoDepartments) : [];
const classGroupsData = djangoClassGroups ? JSON.parse(djangoClassGroups) : [];
const studentsData = djangoStudents ? JSON.parse(djangoStudents) : [];
let assignedStudentIds = djangoAssignedStudents ? JSON.parse(djangoAssignedStudents) : [];

let currentActionId = null;

/* ========================
   FILTER SECTION (TOP)
======================== */
const filterSchool = document.getElementById('filterSchool');
const filterSemester = document.getElementById('filterSemester');
const filterDepartment = document.getElementById('filterDepartment');
const filterClassGroup = document.getElementById('filterClassGroup');

function populateFilterSemesters(schoolId) {
  const sems = semestersData.filter(s => !schoolId || String(s.school_id) === String(schoolId));
  filterSemester.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    sems.map(s => {
      const label = s.name || `${s.school_year}-${s.term}`;
      const sel = '{{ filter_semester }}' === String(s.id) ? 'selected' : '';
      return `<option value="${s.id}" ${sel}>${escapeHtml(label)}</option>`;
    }).join('');
}

function populateFilterDepartments(schoolId) {
  const depts = departmentsData.filter(d => !schoolId || String(d.school_id) === String(schoolId));
  filterDepartment.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    depts.map(d => {
      const sel = '{{ filter_department }}' === String(d.id) ? 'selected' : '';
      return `<option value="${d.id}" ${sel}>${escapeHtml(d.name)}</option>`;
    }).join('');
}

function populateFilterClassGroups(schoolId, semesterId, departmentId) {
  let groups = classGroupsData;
  if (schoolId) groups = groups.filter(g => String(g.school_id) === String(schoolId));
  if (semesterId) groups = groups.filter(g => String(g.semester_id || '') === String(semesterId));
  if (departmentId) groups = groups.filter(g => String(g.department_id || '') === String(departmentId));
  
  filterClassGroup.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    groups.map(g => {
      const sel = '{{ filter_class_group }}' === String(g.id) ? 'selected' : '';
      return `<option value="${g.id}" ${sel}>${escapeHtml(g.name)}</option>`;
    }).join('');
}

filterSchool.addEventListener('change', () => {
  const sid = filterSchool.value || null;
  populateFilterSemesters(sid);
  populateFilterDepartments(sid);
  populateFilterClassGroups(sid, null, null);
});

filterSemester.addEventListener('change', () => {
  populateFilterClassGroups(filterSchool.value, filterSemester.value, filterDepartment.value);
});

filterDepartment.addEventListener('change', () => {
  populateFilterClassGroups(filterSchool.value, filterSemester.value, filterDepartment.value);
});

// Init
populateFilterSemesters('{{ filter_school }}');
populateFilterDepartments('{{ filter_school }}');
populateFilterClassGroups('{{ filter_school }}', '{{ filter_semester }}', '{{ filter_department }}');


/* ========================
   ASSIGN SECTION (BOTTOM)
======================== */
const assignSchool = document.getElementById('assignSchool');
const assignSemester = document.getElementById('assignSemester');
const assignDepartment = document.getElementById('assignDepartment');
const assignClassGroup = document.getElementById('assignClassGroup');
const studentTableBody = document.getElementById('studentTableBody');
const studentFilter = document.getElementById('studentFilter');
const visibleCount = document.getElementById('visibleCount');
const selectedCount = document.getElementById('selectedCount');

let filteredStudents = [];

function populateAssignSemesters(schoolId) {
  const sems = semestersData.filter(s => !schoolId || String(s.school_id) === String(schoolId));
  assignSemester.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    sems.map(s => {
      const label = s.name || `${s.school_year}-${s.term}`;
      return `<option value="${s.id}">${escapeHtml(label)}</option>`;
    }).join('');
}

function populateAssignDepartments(schoolId) {
  const depts = departmentsData.filter(d => !schoolId || String(d.school_id) === String(schoolId));
  assignDepartment.innerHTML = '<option value="">–ë“Ø–≥–¥</option>' +
    depts.map(d => `<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('');
}

function populateAssignClassGroups(schoolId, semesterId, departmentId) {
  let groups = classGroupsData;
  if (schoolId) groups = groups.filter(g => String(g.school_id) === String(schoolId));
  if (semesterId) groups = groups.filter(g => String(g.semester_id || '') === String(semesterId));
  if (departmentId) groups = groups.filter(g => String(g.department_id || '') === String(departmentId));
  
  assignClassGroup.innerHTML = '<option value="">-- –°–æ–Ω–≥–æ–Ω–æ —É—É --</option>' +
    groups.map(g => `<option value="${g.id}">${escapeHtml(g.name)}</option>`).join('');
}

function filterStudents() {
  const schoolId = assignSchool.value || null;
  const deptId = assignDepartment.value || null;
  const searchQ = (studentFilter.value || '').toLowerCase();
  
  filteredStudents = studentsData.filter(s => {
    // Filter by school if student has any school assignments
    if (schoolId && s.school_ids && s.school_ids.length > 0) {
      if (!s.school_ids.some(sid => String(sid) === String(schoolId))) {
        return false;
      }
    }
    
    const text = `${s.student_code} ${s.full_name}`.toLowerCase();
    return !searchQ || text.includes(searchQ);
  });
  
  renderStudents();
}

function renderStudents() {
  if (filteredStudents.length === 0) {
    studentTableBody.innerHTML = '<tr><td style="padding:2rem; text-align:center; color:#9ca3af;">–û—é—É—Ç–∞–Ω –æ–ª–¥—Å–æ–Ω–≥“Ø–π</td></tr>';
  } else {
    studentTableBody.innerHTML = filteredStudents.map(s => `
      <tr class="student-row">
        <td style="padding:0.6rem;">
          <label style="cursor:pointer; display:flex; align-items:center;">
            <input class="student-checkbox" type="checkbox" name="student_ids" value="${s.id}">
            <span style="margin-left:0.7rem;">
              <strong>${escapeHtml(s.student_code)}</strong> - ${escapeHtml(s.full_name)}
            </span>
          </label>
        </td>
      </tr>
    `).join('');
    
    document.querySelectorAll('.student-checkbox').forEach(cb => {
      cb.addEventListener('change', updateCounters);
    });
  }
  
  updateCounters();
}

function updateCounters() {
  visibleCount.textContent = filteredStudents.length;
  selectedCount.textContent = document.querySelectorAll('.student-checkbox:checked').length;
}

assignSchool.addEventListener('change', () => {
  const sid = assignSchool.value || null;
  populateAssignSemesters(sid);
  populateAssignDepartments(sid);
  populateAssignClassGroups(sid, null, null);
  filterStudents();
});

assignSemester.addEventListener('change', () => {
  populateAssignClassGroups(assignSchool.value, assignSemester.value, assignDepartment.value);
});

assignDepartment.addEventListener('change', () => {
  populateAssignClassGroups(assignSchool.value, assignSemester.value, assignDepartment.value);
  // Remove department filtering since student table doesn't have department_id
  filterStudents();
});

studentFilter.addEventListener('input', filterStudents);

document.getElementById('selectAllBtn').addEventListener('click', () => {
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = true);
  updateCounters();
});

document.getElementById('deselectAllBtn').addEventListener('click', () => {
  document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
  updateCounters();
});

// Init assign section
populateAssignSemesters(null);
populateAssignDepartments(null);
populateAssignClassGroups(null, null, null);
filterStudents();


/* ========================
   ACTION MENU
======================== */
const actionMenu = document.getElementById('actionMenu');

function openMenu(e, id) {
  currentActionId = id;
  const rect = e.target.getBoundingClientRect();
  actionMenu.style.display = 'block';
  actionMenu.style.position = 'fixed';
  actionMenu.style.top = `${rect.bottom + 5}px`;
  actionMenu.style.left = `${rect.left - 120}px`;
}

function deleteItem() {
  if (!confirm('–•–æ–ª–±–æ–ª—Ç—ã–≥ —É—Å—Ç–≥–∞—Ö —É—É?')) return;
  document.getElementById('deleteId').value = currentActionId;
  document.getElementById('deleteForm').submit();
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.action-menu') && !e.target.closest('.action-dots')) {
    actionMenu.style.display = 'none';
  }
});

// Delete filtered
const btnDeleteFiltered = document.getElementById('btnDeleteFiltered');
if (btnDeleteFiltered) {
  btnDeleteFiltered.addEventListener('click', () => {
    if (!confirm('–®“Ø“Ø–≥–¥—Å—ç–Ω –±“Ø—Ö —Ö–æ–ª–±–æ–ª—Ç—ã–≥ —É—Å—Ç–≥–∞—Ö —É—É? –≠–Ω—ç “Ø–π–ª–¥–ª–∏–π–≥ –±—É—Ü–∞–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π!')) return;
    document.getElementById('deleteFilteredForm').submit();
  });
}

function escapeHtml(t) {
  const div = document.createElement('div');
  div.textContent = t == null ? '' : t;
  return div.innerHTML;
}
</script>

{% endblock %}
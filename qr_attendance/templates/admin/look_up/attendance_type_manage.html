{% extends "base.html" %}
{% block title %}–ò—Ä—Ü–∏–π–Ω —Ç”©—Ä”©–ª{% endblock %}
{% block content %}

<link rel="stylesheet" href="/static/css/table_data.css">

<div style="max-width:1200px; margin:1.5rem auto;">

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
    <div style="display:flex; align-items:center; gap:0.75rem;">
      <!-- –ë—É—Ü–∞—Ö —Ç–æ–≤—á -->
      <a href="/admin/look-up/" class="btn-secondary" style="text-decoration: none;">
        ‚Üê
      </a>
      <h2 style="margin:0; color:#0b2e78;">–ò—Ä—Ü–∏–π–Ω —Ç”©—Ä”©–ª</h2>
    </div>
    <button id="btnAdd" class="btn-primary">–ù—ç–º—ç—Ö</button>
  </div>

  {% if error %}
    <div class="alert-error">{{ error }}</div>
  {% endif %}

  <!-- Search + Count -->
  <div style="display:flex; gap:0.8rem; margin-bottom:1rem; align-items:center;">
    <input id="searchInput" placeholder="–•–∞–π—Ö..."
           style="flex:1; max-width:320px; padding:0.6rem; border:1px solid #e5e7eb; border-radius:6px;">
    <div style="color:#6b7280;">–ù–∏–π—Ç: <strong id="totalCount">0</strong> |
      “Æ–∑“Ø“Ø–ª–∂ –±–∞–π–≥–∞–∞: <strong id="showingCount">0</strong>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th data-sort="id" style="width:80px;">‚Ññ <span class="sort-icon">‚áÖ</span></th>
          <th data-sort="name">–ù—ç—Ä <span class="sort-icon">‚áÖ</span></th>
          <th data-sort="value" style="width:120px;">–£—Ç–≥–∞ <span class="sort-icon">‚áÖ</span></th>
          <th style="width:100px; text-align:center;">“Æ–π–ª–¥—ç–ª</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr>
          <td colspan="4" style="text-align:center; padding:2rem; color:#9ca3af;">
            –ê—á–∞–∞–ª–ª–∞–∂ –±–∞–π–Ω–∞...
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="pagination" class="pagination"></div>

</div>

<!-- ADD Modal -->
<div id="addModal" class="modal">
  <div class="modal-content" style="max-width:480px;">
    <div class="modal-header">
      <h3>–®–∏–Ω—ç —Ç”©—Ä”©–ª –Ω—ç–º—ç—Ö</h3>
      <button class="modal-close" onclick="closeAddModal()">‚úï</button>
    </div>

    <form method="POST" id="addForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="add">

      <div class="form-group">
        <label>–ù—ç—Ä</label>
        <input name="name" id="add-name" required>
      </div>

      <div class="form-group">
        <label>–£—Ç–≥–∞</label>
        <input name="value" id="add-value" required>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeAddModal()">–ë–æ–ª–∏—Ö</button>
        <button type="submit" class="btn-primary">–•–∞–¥–≥–∞–ª–∞—Ö</button>
      </div>
    </form>
  </div>
</div>

<!-- EDIT Modal -->
<div id="editModal" class="modal">
  <div class="modal-content" style="max-width:480px;">
    <div class="modal-header">
      <h3>–ó–∞—Å–∞—Ö</h3>
      <button class="modal-close" onclick="closeEditModal()">‚úï</button>
    </div>

    <form method="POST" id="editForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="edit">
      <input type="hidden" id="edit-id" name="id">

      <div class="form-group">
        <label>–ù—ç—Ä</label>
        <input id="edit-name" name="name" required>
      </div>

      <div class="form-group">
        <label>–£—Ç–≥–∞</label>
        <input id="edit-value" name="value" required>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeEditModal()">–ë–æ–ª–∏—Ö</button>
        <button type="submit" class="btn-primary">–•–∞–¥–≥–∞–ª–∞—Ö</button>
      </div>
    </form>
  </div>
</div>

<!-- Action Menu -->
<div id="actionMenu" class="action-menu">
  <button class="action-item" onclick="editItem()">‚úèÔ∏è –ó–∞—Å–∞—Ö</button>
  <button class="action-item action-delete" onclick="deleteItem()">üóëÔ∏è –£—Å—Ç–≥–∞—Ö</button>
</div>

<script>
const djangoData = '{{ items|escapejs }}';
let allData = JSON.parse(djangoData || "[]");
let filteredData = [...allData];
let currentPage = 1;
const itemsPerPage = 10;
let sortColumn = "id";
let sortDirection = "asc";
let currentActionId = null;

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  renderTable();
  setupEvents();
});

/* EVENTS */
function setupEvents() {
  document.getElementById("searchInput").oninput = (e) => {
    const q = e.target.value.toLowerCase();
    filteredData = allData.filter(x =>
      x.name.toLowerCase().includes(q) ||
      x.value.toLowerCase().includes(q)
    );
    currentPage = 1;
    renderTable();
  };

  document.querySelectorAll("th[data-sort]").forEach(th => {
    th.onclick = () => {
      const col = th.dataset.sort;
      if (sortColumn === col) sortDirection = sortDirection === "asc" ? "desc" : "asc";
      else { sortColumn = col; sortDirection = "asc"; }
      sortData();
      renderTable();
    };
  });

  document.getElementById("btnAdd").onclick = () =>
    document.getElementById("addModal").style.display = "flex";
}

/* SORT */
function sortData() {
  filteredData.sort((a, b) => {
    const A = String(a[sortColumn]).toLowerCase();
    const B = String(b[sortColumn]).toLowerCase();
    return sortDirection === "asc" ? A.localeCompare(B) : B.localeCompare(A);
  });
}

/* TABLE RENDER */
function renderTable() {
  const tbody = document.getElementById("tableBody");
  const start = (currentPage - 1) * itemsPerPage;
  const pageData = filteredData.slice(start, start + itemsPerPage);

  if (!pageData.length) {
    tbody.innerHTML =
      `<tr><td colspan="4" style="text-align:center;padding:1.4rem;">”®–≥”©–≥–¥”©–ª –±–∞–π—Ö–≥“Ø–π</td></tr>`;
    return;
  }

  tbody.innerHTML = pageData.map((x, i) => `
    <tr>
      <td>${start + i + 1}</td>
      <td>${escapeHtml(x.name)}</td>
      <td><span class="badge">${escapeHtml(x.value)}</span></td>
      <td style="text-align:center;">
        <button class="action-dots" onclick="openMenu(event, ${x.id})">‚ãÆ</button>
      </td>
    </tr>
  `).join("");

  document.getElementById("totalCount").textContent = allData.length;
  document.getElementById("showingCount").textContent = filteredData.length;
  renderPagination();
}

/* PAGINATION */
function renderPagination() {
  const total = Math.ceil(filteredData.length / itemsPerPage);
  const pag = document.getElementById("pagination");

  if (total <= 1) {
    pag.innerHTML = "";
    return;
  }

  let html = "";
  for (let i = 1; i <= total; i++) {
    html += `<button onclick="changePage(${i})" class="${i === currentPage ? "active" : ""}">${i}</button>`;
  }
  pag.innerHTML = html;
}

function changePage(p) {
  currentPage = p;
  renderTable();
}

/* ACTION MENU */
const actionMenu = document.getElementById("actionMenu");
let menuHover = false;

actionMenu.addEventListener("mouseenter", () => menuHover = true);
actionMenu.addEventListener("mouseleave", () => {
  menuHover = false;
  setTimeout(() => { if (!menuHover) actionMenu.style.display = "none"; }, 80);
});

document.addEventListener("click", (e) => {
  if (!e.target.closest(".action-menu") && !e.target.closest(".action-dots")) {
    actionMenu.style.display = "none";
  }
});

function openMenu(e, id) {
  currentActionId = id;
  const rect = e.target.getBoundingClientRect();
  actionMenu.style.display = "block";
  actionMenu.style.top = `${rect.bottom + 5}px`;
  actionMenu.style.left = `${rect.left - 120}px`;
}

/* EDIT */
function editItem() {
  const item = allData.find(x => x.id === currentActionId);
  if (!item) return;
  document.getElementById("edit-id").value = item.id;
  document.getElementById("edit-name").value = item.name;
  document.getElementById("edit-value").value = item.value;
  document.getElementById("editModal").style.display = "flex";
  actionMenu.style.display = "none";
}

/* DELETE */
function deleteItem() {
  if (!confirm("–£—Å—Ç–≥–∞—Ö —É—É?")) return;

  const form = document.createElement("form");
  form.method = "POST";
  form.innerHTML = `
    {% csrf_token %}
    <input type="hidden" name="action" value="delete">
    <input type="hidden" name="id" value="${currentActionId}">
  `;
  document.body.appendChild(form);
  form.submit();
}

/* MODALS */
function closeAddModal() {
  document.getElementById("addModal").style.display = "none";
  document.getElementById("addForm").reset();
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
  document.getElementById("editForm").reset();
}

/* UTIL */
function escapeHtml(t) {
  const div = document.createElement("div");
  div.textContent = t;
  return div.innerHTML;
}
</script>

{% endblock %}
